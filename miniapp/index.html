<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram Mini App</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap&subset=cyrillic" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=add_card,key_vertical,send" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geologica:wght@100..900&family=Martian+Mono:wght@100..800&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #181c22;
      color: #fff;
      font-family: 'Geologica', sans-serif;
      font-optical-sizing: auto;
      font-variation-settings: "slnt" 0, "CRSV" 0, "SHRP" 0;
      font-weight: 300;
      box-sizing: border-box;
    }
    *, *:before, *:after {
      box-sizing: inherit;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
      overflow-x: hidden;
      overflow-y: hidden;
      background: #181c22;
    }
    .container {
      width: 100vw;
      max-width: 100vw;
      height: 100vh;
      max-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #181c22;
      box-shadow: none;
      border-radius: 0;
      padding: 0;
      box-sizing: border-box;
      position: relative;
    }
    .header {
      width: 100vw;
      max-width: 100vw;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5em 2em 1em 2em;
      min-height: 72px;
      box-sizing: border-box;
      background: #1a1d21;
      z-index: 1002;
      border-bottom: 1.5px solid #23272f;
      box-shadow: 0 2px 16px #0004;
      position: relative;
    }
    .app-title {
      font-size: 1.45em;
      font-weight: 700;
      color: #fff;
      letter-spacing: 1.5px;
      display: flex;
      align-items: center;
      gap: 0.5em;
      text-shadow: 0 2px 8px #0006;
      user-select: none;
    }
    .app-title .logo {
      font-size: 1.25em;
      margin-right: 0.3em;
      filter: drop-shadow(0 2px 4px #0008);
    }
    .header > div {
      display: flex; gap: 0.7em; align-items: center;
      margin-left: 1.2em;
    }
    .header-icon {
      font-size: 1.35em;
      filter: drop-shadow(0 2px 4px #0008);
      vertical-align: middle;
      pointer-events: none;
      user-select: none;
    }
    .key-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #23272f;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px #0003;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }
    .key-btn:hover {
      background: #2d323b;
    }
    .key-btn svg {
      width: 22px;
      height: 22px;
      fill: #7ecfff;
    }
    /* Удаляю .apikey-float и .apikey-modal-backdrop, теперь используется .modal */
    .apikey-btn {
      width: 100%;
      min-width: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #181c22;
      color: #fff;
      border: 1.5px solid #23272f;
      border-radius: 18px;
      font-size: 1.13em;
      font-weight: 700;
      box-shadow: 0 4px 16px #0008, 0 0 0 2px #23272f inset;
      transition: box-shadow 0.2s, background 0.2s, color 0.2s;
      cursor: pointer;
      margin: 0;
      letter-spacing: 0.5px;
      padding: 0.8em 1.5em;
    }
    .apikey-btn:hover, .apikey-btn:focus {
      background: #23272f;
      color: #fff;
      box-shadow: 0 6px 24px #000b, 0 0 0 2.5px #23272f inset;
    }
    .apikey-float input {
      width: 100%;
      min-width: 0;
      max-width: 220px;
      padding: 0.7em 1em;
      border-radius: 10px;
      border: 1px solid #333a;
      background: #181c22;
      color: #fff;
      font-size: 1em;
      margin-bottom: 0.5em;
      overflow: hidden;
      text-overflow: ellipsis;
      box-sizing: border-box;
    }
    .apikey-float label {
      font-size: 0.98em;
      color: #fff;
      margin-bottom: 0.3em;
      display: block;
    }
    .user {
      margin: 0.5em 0 0.5em 1.2em;
      font-size: 1.05em;
      color: #fff;
      opacity: 0.85;
    }
    .chatbox {
      flex: 1 1 auto;
      width: 100vw;
      max-width: 100vw;
      overflow-y: auto;
      padding: 1.2em 0.8em 1.2em 0.8em;
      box-sizing: border-box;
      background: transparent;
      display: flex;
      flex-direction: column;
      gap: 0.7em;
      font-size: 1.04em;
      scroll-behavior: smooth;
      padding-bottom: 5em; /* чтобы input-row не перекрывал */
    }
    .msg {
      max-width: 80vw;
      padding: 0.9em 2.2em;
      border-radius: 8px;
      margin-bottom: 0.2em;
      word-break: break-word;
      box-shadow: 0 2px 8px #0002;
      background: #22252a;
      color: #fff;
      align-self: flex-start;
      font-family: 'Geologica', sans-serif;
      font-optical-sizing: auto;
      font-variation-settings: "slnt" 0, "CRSV" 0, "SHRP" 0;
      font-weight: 100;
    }
    .msg.user {
      background: #e3f0ff;
      color: #1a2330;
      align-self: flex-end;
      box-shadow: 0 2px 8px #0002;
      border-radius: 8px;
      padding-left: 2.2em;
      padding-right: 2.2em;
      font-family: 'Geologica', sans-serif;
      font-optical-sizing: auto;
      font-variation-settings: "slnt" 0, "CRSV" 0, "SHRP" 0;
      font-weight: 100;
    }
    .msg.assistant {
      background: #22252a;
      color: #fff;
      border-radius: 8px;
      padding-left: 2.2em;
      padding-right: 2.2em;
      font-family: 'Geologica', sans-serif;
      font-optical-sizing: auto;
      font-variation-settings: "slnt" 0, "CRSV" 0, "SHRP" 0;
      font-weight: 100;
    }
    .booking-card {
      background: #23272f;
      color: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 12px #0004;
      margin: 0.25em 0;
      padding: 1.2em 1em 1em 1em;
      position: relative;
      max-width: 98vw;
      font-size: 1.04em;
      transition: border 0.2s, box-shadow 0.2s;
      font-family: 'Geologica', sans-serif;
      font-optical-sizing: auto;
      font-variation-settings: "slnt" 0, "CRSV" 0, "SHRP" 0;
      font-weight: 100;
    }
    .booking-card.selected {
      border: 2px solid #444;
      box-shadow: 0 0 0 2px #222;
    }
    .booking-btn, .booking-btn.confirm-btn {
      background: #181a1f;
      color: #fff;
      border: 1.5px solid #23272f;
      border-radius: 50px;
      padding: 0.7em 2.2em;
      font-weight: 700;
      cursor: pointer;
      margin: 0.5em 0.2em 0 0;
      font-size: 1.13em;
      transition: box-shadow 0.2s, background 0.2s, border 0.2s;
      box-shadow: 0 4px 16px #0008, 0 0 0 2px #23272f inset;
      outline: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
      min-height: 44px;
      height: 44px;
      line-height: 1;
    }
    .booking-btn:hover, .booking-btn.confirm-btn:hover {
      background: #23272f;
      box-shadow: 0 6px 24px #000b, 0 0 0 2.5px #23272f inset;
      border: 1.5px solid #23272f;
      color: #fff;
    }
    .input-row {
      width: 100vw;
      max-width: 100vw;
      background: transparent;
      padding: 0 0 1.2em 0;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: flex-end;
    }
    .input-wrapper {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      align-items: flex-end;
    }
    .input-row input {
      display: none;
    }
    .input-row textarea {
      width: 100%;
      min-height: 120px;
      max-height: 160px;
      height: 140px;
      padding: 2.2em 4em 0.7em 2em;
      border-radius: 22px;
      border: 1.5px solid #333a;
      background: #24272d;
      color: #fff;
      font-size: 1.13em;
      outline: none;
      margin: 0;
      box-shadow: 0 2px 12px #0003;
      box-sizing: border-box;
      transition: border 0.2s;
      resize: none;
      vertical-align: top;
      text-align: left;
      margin-right: 0.7em;
    }
    .input-row textarea:focus {
      border: 1.5px solid #7ecfff;
    }
    .input-row button {
      position: absolute;
      right: 1.1em;
      bottom: 1.1em;
      background: #181a1f;
      color: #fff;
      border: 1.5px solid #23272f;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.25em;
      font-weight: 700;
      cursor: pointer;
      transition: box-shadow 0.2s, background 0.2s, border 0.2s;
      box-shadow: 0 4px 16px #0008, 0 0 0 2px #23272f inset;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      margin: 0;
      outline: none;
    }
    .input-row button:hover, .input-row button:focus {
      background: #23272f;
      box-shadow: 0 6px 24px #000b, 0 0 0 2.5px #23272f inset;
      border: 1.5px solid #23272f;
      color: #fff;
    }
    .input-row button svg {
      width: 1.3em;
      height: 1.3em;
      fill: #fff;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0; top: 0; width: 100vw;
      min-height: 100dvh;
      background: rgba(24,28,34,0.85);
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .modal.active {
      display: flex;
      animation: fadeIn 0.2s;
    }
    .modal-content {
      background: #23272f;
      border-radius: 18px;
      padding: 2.5em 2em 2em 2em;
      min-width: 220px;
      max-width: 340px;
      width: 100%;
      margin: 0 auto;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
      color: #fff;
      border: 1.5px solid #23272f;
      box-shadow: 0 8px 32px #000b, 0 0 0 2px #23272f inset;
      animation: fadeIn 0.25s;
      max-height: 90dvh;
      overflow-y: auto;
    }
    .modal-content .modal-icon {
      font-size: 2.5em;
      margin-bottom: 0.3em;
      filter: drop-shadow(0 2px 8px #0008);
      user-select: none;
    }
    .modal-content h3 {
      font-size: 1.35em;
      font-weight: 700;
      margin: 0 0 1.2em 0;
      letter-spacing: 0.5px;
      text-align: center;
      color: #fff;
    }
    .modal-content input[type="text"],
    .modal-content input[type="password"] {
      width: 100%;
      padding: 0.95em 1.2em 0.95em 2.5em; /* чуть меньше padding-top/bottom */
      border-radius: 12px;
      border: 1.5px solid #333a;
      background: #181c22;
      color: #fff;
      font-size: 0.68em;
      margin-bottom: 0.7em;
      box-shadow: 0 2px 8px #0002;
      box-sizing: border-box;
      outline: none;
      transition: border 0.2s;
      position: relative;
      line-height: 1.2;
      font-family: 'Martian Mono', 'Roboto Mono', monospace !important;
      font-optical-sizing: auto;
      font-variation-settings: "wdth" 100;
    }
    .modal-content input[type="text"]:focus,
    .modal-content input[type="password"]:focus {
      border: 1.5px solid #7ecfff;
    }
    .modal-content .input-icon {
      position: absolute;
      left: 1.1em;
      top: 50%;
      transform: translateY(-52%) rotate(-45deg); /* было -50%, чуть ниже, теперь повернуто */
      font-size: 1.3em; /* увеличено */
      color: #fff;
      pointer-events: none;
      vertical-align: middle;
      line-height: 1;
    }
    .modal-content .modal-input-wrap {
      position: relative;
      width: 100%;
      margin-bottom: 0.7em;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content input[type="text"]:focus {
      border: 1.5px solid #7ecfff;
    }
    .modal-content .modal-input-wrap {
      position: relative;
      width: 100%;
      margin-bottom: 0.7em;
    }
    #pay-btn {
      margin-top: 0.7em;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #181a1f;
      color: #fff;
      border: 1.5px solid #23272f;
      border-radius: 50px;
      font-size: 1.13em;
      font-weight: 700;
      padding: 0.9em 0;
      box-shadow: 0 4px 16px #0008, 0 0 0 2px #23272f inset;
      transition: box-shadow 0.2s, background 0.2s, border 0.2s;
      cursor: pointer;
    }
    #pay-btn:hover, #pay-btn:focus {
      background: #23272f;
      box-shadow: 0 6px 24px #000b, 0 0 0 2.5px #23272f inset;
      border: 1.5px solid #23272f;
      color: #fff;
    }
    #pay-btn svg {
      width: 1.3em;
      height: 1.3em;
      fill: #fff;
      margin-right: 0.6em;
      vertical-align: middle;
    }
    .modal-close {
      position: absolute;
      top: 1em; right: 1em;
      font-size: 1.5em;
      color: #e3f0ff;
      cursor: pointer;
      z-index: 10;
    }
    .modal-backdrop {
      display: none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(24,28,34,0.95);
      z-index: 1000;
    }
    .modal-backdrop.active {
      display: block;
      animation: fadeIn 0.2s;
    }
    @media (max-width: 600px) {
      .chatbox, .msg, .booking-card {
        font-size: 0.98em;
        padding-left: 0.5em;
        padding-right: 0.5em;
        box-sizing: border-box;
      }
      .input-row {
        padding-left: 0.5em;
        padding-right: 0.5em;
        box-sizing: border-box;
      }
      .apikey-float {
        right: 8px;
        min-width: 0;
        width: 95vw;
        max-width: 220px;
        box-sizing: border-box;
      }
      .modal-content {
        min-width: 90vw;
        max-width: 95vw;
        width: 90vw;
        padding: 1.2em 0.5em 1em 0.5em;
        box-sizing: border-box;
      }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: none; }
    }
    .booking-btn svg, .booking-btn.confirm-btn svg, #pay-btn svg {
      width: 1.2em;
      height: 1.2em;
      fill: #fff;
      margin-right: 0.5em;
      vertical-align: middle;
    }
    @media (max-width: 900px) {
      .apikey-float-inner {
        flex-direction: column;
        align-items: stretch;
        min-width: 0;
        max-width: 99vw;
        width: 99vw;
        padding: 1.2em 0.7em 1.2em 0.7em;
        gap: 1.1em;
      }
      .apikey-float .apikey-icon {
        margin: 0 0 0.7em 0;
        justify-content: center;
      }
      .apikey-float input {
        margin-bottom: 1.1em;
        min-width: 0;
        max-width: 100%;
      }
      .apikey-float .apikey-btn {
        width: 100%;
        min-width: 0;
        border-radius: 50px;
        margin-top: 0.7em;
        height: 48px;
      }
    }
    .modal, .modal-content {
      -webkit-overflow-scrolling: touch;
    }
    @media (max-width: 600px) {
      .modal {
        position: absolute;
        align-items: flex-start;
        justify-content: flex-start;
      }
      .modal-content {
        margin-top: 15vh;
      }
    }
    .modal-content.apikey-modal-content {
      min-height: 320px;
    }
    @media (max-width: 600px) {
      .modal-content.apikey-modal-content {
        min-height: 220px;
      }
    }
    .material-symbols-outlined.header-icon {
      color: #fff;
      font-size: 18px;
      font-variation-settings:
        'FILL' 0,
        'wght' 200,
        'GRAD' 0,
        'opsz' 24;
    }
    #show-key-btn .material-symbols-outlined.header-icon {
      transform: rotate(-45deg);
    }
    .material-symbols-outlined.send-icon {
      font-size: 36px;
      transform: rotate(-45deg) scale(0.67);
      display: inline-block;
      vertical-align: middle;
      transition: color 0.2s;
      font-variation-settings:
        'FILL' 0,
        'wght' 200,
        'GRAD' 0,
        'opsz' 24;
      background: linear-gradient(115deg, rgba(255,255,255,0.75) 60%, rgba(255,255,255,0) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
    }
    /* --- Исправление: явно задаём шрифт для #user-input, чтобы работало на iPhone --- */
    #user-input {
      font-family: 'Roboto Mono', 'Martian Mono', monospace !important;
      font-optical-sizing: auto;
      font-variation-settings: "wdth" 100;
      font-weight: 300;
      font-size: 0.85em;
    }
  </style>
</head>
<body>
  <div class="modal" id="apikey-modal">
    <div class="modal-content apikey-modal-content">
      <span class="modal-close" onclick="closeApikeyModal()">&times;</span>
      <span class="modal-icon">🔑</span>
      <h3>Введите API Key</h3>
      <div style="width:100%;margin-bottom:0.7em;">
        <label for="api-provider" style="font-size:0.98em;color:#fff;">Выберите API:</label>
        <select id="api-provider" style="width:100%;padding:0.7em 1em;border-radius:10px;border:1px solid #333a;background:#181c22;color:#fff;font-size:0.98em;margin-top:0.2em;font-family:'Martian Mono','Roboto Mono',monospace;">
          <option value="gemini">Gemini</option>
          <option value="openai">ChatGPT (OpenAI)</option>
          <option value="deepseek">DeepSeek</option>
          <option value="groq">Groq</option>
          <option value="mistral">Mistral (Large)</option>
          <option value="other">Другое</option>
        </select>
        <div id="api-endpoint-wrap" style="display:none;margin-top:0.7em;">
          <label for="api-endpoint" style="font-size:0.98em;color:#fff;">Endpoint:</label>
          <input type="text" id="api-endpoint" placeholder="https://example.com/api" style="width:100%;padding:0.7em 1em;border-radius:10px;border:1px solid #333a;background:#181c22;color:#fff;font-size:0.89em;margin-top:0.2em;font-family:'Martian Mono','Roboto Mono',monospace;" />
        </div>
        <!-- Выбор модели -->
        <div id="api-model-wrap" style="margin-top:0.7em;">
          <label for="api-model" style="font-size:0.98em;color:#fff;">Модель:</label>
          <select id="api-model" style="width:100%;padding:0.7em 1em;border-radius:10px;border:1px solid #333a;background:#181c22;color:#fff;font-size:0.98em;margin-top:0.2em;font-family:'Martian Mono','Roboto Mono',monospace;"></select>
          <input type="text" id="api-model-custom" placeholder="Введите model id" style="display:none;width:100%;padding:0.7em 1em;border-radius:10px;border:1px solid #333a;background:#181c22;color:#fff;font-size:0.89em;margin-top:0.2em;font-family:'Martian Mono','Roboto Mono',monospace;" />
        </div>
        <!-- Скрытая кнопка для открытия логов -->
        <button id="show-console-btn" title="Show logs" aria-label="Show logs" style="position:absolute;left:12px;top:12px;width:22px;height:22px;opacity:0.18;z-index:10;background:none;border:none;cursor:pointer;padding:0;transition:opacity 0.2s;">🐞</button>
      </div>
      
      <div class="modal-input-wrap" style="position:relative;display:flex;align-items:center;width:100%;">
        <span class="input-icon">🔑</span>
        <input type="text" id="api-key" placeholder="API Key" autocomplete="off" inputmode="text" spellcheck="false" style="padding-left:2.5em;padding-right:5.5em;width:100%;max-width:340px;border:2px solid #7ecfff;background:#232b36;color:#fff;box-shadow:0 2px 12px #0003;border-radius:14px;font-size:0.98em;font-family:'Martian Mono','Roboto Mono',monospace;" />
        <button id="api-key-clear-btn" type="button" title="Очистить" style="position:absolute;right:2.7em;top:40%;transform:translateY(-50%);background:#23272f;border:none;color:#aaa;font-size:1.1em;cursor:pointer;padding:0;width:2em;height:2em;display:flex;align-items:center;justify-content:center;border-radius:50%;box-shadow:0 1px 4px #0002;transition:background 0.15s;">
          ✕
        </button>
        <button id="api-key-paste-btn" type="button" title="Вставить из буфера" style="position:absolute;right:0.3em;top:40%;transform:translateY(-50%);background:#23272f;border:none;color:#7ecfff;font-size:1.1em;cursor:pointer;padding:0;width:2em;height:2em;display:flex;align-items:center;justify-content:center;border-radius:50%;box-shadow:0 1px 4px #0002;transition:background 0.15s;">
          📋
        </button>
      </div>
      <button class="apikey-btn" id="apikey-save-btn" type="button" style="margin-top:0.7em;width:100%;display:flex;align-items:center;justify-content:center;background:#181a1f;color:#fff;border:1.5px solid #23272f;border-radius:50px;font-size:1.13em;font-weight:700;padding:0.9em 0;box-shadow:0 4px 16px #0008,0 0 0 2px #23272f inset;transition:box-shadow 0.2s,background 0.2s,border 0.2s;cursor:pointer;">Добавить</button>
    </div>
  </div>
  <!-- Modal for console logs -->
  <div class="modal" id="console-log-modal">
    <div class="modal-content" style="max-width:600px;min-width:220px;">
      <span class="modal-close" onclick="closeConsoleLogModal()">&times;</span>
      <span class="modal-icon">🐞</span>
      <h3>Console logs</h3>
      <div id="console-log-content" style="width:100%;max-height:300px;overflow-y:auto;background:#181c22;color:#fff;font-size:0.92em;font-family:'Martian Mono','Roboto Mono',monospace;border-radius:8px;padding:1em 0.5em 1em 0.5em;margin-bottom:1em;"></div>
    </div>
  </div>
  <div class="container">
    <div class="header">
      <span class="app-title">NOW</span>
      <div style="display: flex; gap: 0.7em; align-items: center;">
        <button class="key-btn" id="booking-btn" title="Оформить бронирование">
          <span class="material-symbols-outlined header-icon">add_card</span>
        </button>
      <button class="key-btn" id="show-key-btn" title="API Key">
          <span class="material-symbols-outlined header-icon">key_vertical</span>
      </button>
      </div>
    </div>
    <div class="user" id="user-info">Loading user info...</div>
    <div class="chatbox" id="chatbox"></div>
    <form id="chat-form" class="input-row" autocomplete="off">
      <div class="input-wrapper">
        <textarea id="user-input" placeholder="Например: забронируй столик в ресторане на вечер" required rows="2"></textarea>
        <button type="submit" id="send-btn" title="Send">
          <span class="material-symbols-outlined send-icon">send</span>
        </button>
      </div>
    </form>
    <!-- Payment Modal -->
    <div class="modal" id="payment-modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closePaymentModal()">&times;</span>
        <span class="modal-icon">💳</span>
        <h3>Привязать карту</h3>
        <div id="modal-booking-details"></div>
        <div style="margin: 1em 0; width: 100%;">
          <div class="modal-input-wrap">
            <span class="input-icon">💳</span>
          <input type="text" id="card-number" placeholder="Номер карты: 1234 5678 9012 3456" maxlength="19" />
          </div>
          <div class="modal-input-wrap">
            <span class="input-icon">📅</span>
          <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5" />
          </div>
          <div class="modal-input-wrap">
            <span class="input-icon">🔒</span>
          <input type="text" id="card-cvv" placeholder="CVV" maxlength="3" />
          </div>
          <div class="modal-input-wrap">
            <span class="input-icon">👤</span>
          <input type="text" id="card-name" placeholder="Имя владельца карты" />
          </div>
        </div>
        <button type="button" id="pay-btn"><svg viewBox="0 0 24 24"><path d="M21 7v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2zm-2 0H5v2h14V7zm0 4H5v6h14v-6z"/></svg>Привязать</button>
      </div>
    </div>
  </div>
  <!-- Booking Details Modal -->
  <div class="modal" id="booking-details-modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeBookingDetailsModal()">&times;</span>
      <span class="modal-icon">📄</span>
      <h3>Детали бронирования</h3>
      <div id="booking-details-content" style="width:100%;margin-bottom:1em;"></div>
      <div style="width:100%;margin-bottom:1em;">
        <label style="display:flex;align-items:center;gap:0.7em;font-size:1em;">
          <input type="checkbox" id="booking-agree-checkbox" style="width:1.2em;height:1.2em;" />
          <span>Я подтверждаю, что ознакомлен(а) с условиями бронирования и согласен(на) на обработку персональных данных.</span>
        </label>
      </div>
      <button type="button" id="booking-confirm-btn" style="width:100%;margin-top:0.7em;background:#28a745;color:#fff;border:1.5px solid #23272f;border-radius:50px;font-size:1.13em;font-weight:700;padding:0.9em 0;box-shadow:0 4px 16px #0008,0 0 0 2px #23272f inset;transition:box-shadow 0.2s,background 0.2s,border 0.2s;cursor:pointer;" disabled>Подтвердить</button>
    </div>
  </div>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // --- Console log interception ---
    window.__consoleLogs = [];
    ['log','info','warn','error'].forEach(function(method) {
      const orig = console[method];
      console[method] = function(...args) {
        window.__consoleLogs.push({ type: method, args: args, time: new Date().toISOString() });
        orig.apply(console, args);
      };
    });

    // --- Универсальный обработчик ответа fetch с логированием статуса и json ---
    function handleResponse(response) {
      return response.json()
        .then((json) => {
          if (!response.ok) {
            const error = Object.assign({}, json, {
              status: response.status,
              statusText: response.statusText,
            });
            // Логируем ошибку с деталями
            console.error('API error:', error);
            return Promise.reject(error);
          }
          // Логируем успешный json
          console.info('API success:', json);
          return json;
        });
    }

    // --- fetchWithStatusLog: универсальная обёртка для логирования статусов POST-запросов ---
    async function fetchWithStatusLog(url, options = {}) {
      const method = (options.method || 'GET').toUpperCase();
      const start = Date.now();
      try {
        const response = await fetch(url, options);
        const clone = response.clone();
        let json = null;
        try {
          json = await clone.json();
        } catch (e) {
          json = null;
        }
        const logObj = {
          url,
          method,
          status: response.status,
          statusText: response.statusText,
          duration: Date.now() - start,
          requestBody: options.body,
          response: json
        };
        if (!response.ok) {
          console.error('API POST error:', logObj);
        } else {
          console.info('API POST success:', logObj);
        }
        return response;
      } catch (error) {
        const logObj = {
          url,
          method,
          status: 'network error',
          statusText: '',
          duration: Date.now() - start,
          requestBody: options.body,
          error: error.message
        };
        console.error('API POST network error:', logObj);
        throw error;
      }
    }
    // --- Пример использования (оставлен только как комментарий) ---
    /*
    fetchWithStatusLog('/api/foo', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({foo: 'bar'})
    })
      .then(response => response.json())
      .then(json => {
        // твоя логика
      })
      .catch(error => {
        // обработка ошибки
      });
    */

    // --- Console log modal logic ---
    function openConsoleLogModal() {
      const modal = document.getElementById('console-log-modal');
      const content = document.getElementById('console-log-content');
      if (window.__consoleLogs.length === 0) {
        content.innerHTML = '<em>Нет логов</em>';
      } else {
        content.innerHTML = window.__consoleLogs.map(l => `<div style='margin-bottom:0.4em;'><span style='color:#7ecfff;'>[${l.type}]</span> <span style='color:#aaa;'>${l.time.slice(11,19)}</span> <span>${l.args.map(a => (typeof a==='object'?JSON.stringify(a):a)).join(' ')}</span></div>`).join('');
      }
      modal.classList.add('active');
      // Прокрутка вниз
      setTimeout(() => { content.scrollTop = content.scrollHeight; }, 0);
    }
    function closeConsoleLogModal() {
      document.getElementById('console-log-modal').classList.remove('active');
    }
    document.getElementById('show-console-btn').onclick = openConsoleLogModal;
    document.getElementById('console-log-modal').addEventListener('mousedown', function(e) {
      if (e.target === this) closeConsoleLogModal();
    });

    // Hover-эффект для скрытой кнопки
    const showConsoleBtn = document.getElementById('show-console-btn');
    showConsoleBtn.addEventListener('mouseenter', function() { this.style.opacity = '0.6'; });
    showConsoleBtn.addEventListener('mouseleave', function() { this.style.opacity = '0.18'; });

    // --- Новый модал для API Key ---
    const showKeyBtn = document.getElementById('show-key-btn');
    const apikeyModal = document.getElementById('apikey-modal');
    const apikeySaveBtn = document.getElementById('apikey-save-btn');
    const apiModelWrap = document.getElementById('api-model-wrap');
    const apiModelSelect = document.getElementById('api-model');
    const apiModelCustom = document.getElementById('api-model-custom');

    function openApikeyModal() {
      apikeyModal.classList.add('active');
      const apiKeyInput = document.getElementById('api-key');
      // Подставить сохранённый ключ, если есть
      const savedKey = localStorage.getItem('api_key') || '';
      apiKeyInput.value = savedKey;
      // Подставить сохранённый провайдер, если есть
      const apiProvider = document.getElementById('api-provider');
      const savedProvider = localStorage.getItem('api_provider') || 'gemini';
      apiProvider.value = savedProvider;
      // Подставить сохранённую модель, если есть
      const savedModel = localStorage.getItem('api_model') || '';
      updateModelOptions(savedProvider, savedModel);
      // Endpoint
      const apiEndpointWrap = document.getElementById('api-endpoint-wrap');
      const apiEndpointInput = document.getElementById('api-endpoint');
      const savedEndpoint = localStorage.getItem('api_endpoint') || '';
      apiEndpointInput.value = savedEndpoint;
      if (savedProvider === 'other') {
        apiEndpointWrap.style.display = '';
      } else {
        apiEndpointWrap.style.display = 'none';
      }
      setTimeout(() => { apiKeyInput.focus(); }, 150);
      apiKeyInput.type = 'text';
    }
    function closeApikeyModal() {
      apikeyModal.classList.remove('active');
    }
    showKeyBtn.onclick = openApikeyModal;
    // Селектор API: показывать/скрывать endpoint
    document.getElementById('api-provider').addEventListener('change', function() {
      const apiEndpointWrap = document.getElementById('api-endpoint-wrap');
      if (this.value === 'other') {
        apiEndpointWrap.style.display = '';
      } else {
        apiEndpointWrap.style.display = 'none';
      }
    });
    apikeySaveBtn.onclick = () => {
      const apiKeyInput = document.getElementById('api-key');
      const realValue = apiKeyInput.value || '';
      localStorage.setItem('api_key', realValue.trim());
      // Сохраняем выбранный провайдер
      const apiProvider = document.getElementById('api-provider').value;
      localStorage.setItem('api_provider', apiProvider);
      // Сохраняем выбранную модель
      let modelValue = apiModelSelect.value;
      if (modelValue === 'other') {
        modelValue = apiModelCustom.value.trim();
      }
      localStorage.setItem('api_model', modelValue);
      // Сохраняем endpoint если выбран 'Другое'
      const apiEndpointInput = document.getElementById('api-endpoint');
      if (apiProvider === 'other') {
        localStorage.setItem('api_endpoint', apiEndpointInput.value.trim());
      } else {
        localStorage.removeItem('api_endpoint');
      }
      closeApikeyModal();
    };
    // Клик по тёмной подложке закрывает модалку
    apikeyModal.addEventListener('mousedown', function(e) {
      if (e.target === apikeyModal) {
        closeApikeyModal();
      }
    });
    // Enter на input сохраняет и закрывает
    document.getElementById('api-key').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const realValue = this.value || '';
        localStorage.setItem('api_key', realValue.trim());
        // Сохраняем выбранный провайдер
        const apiProvider = document.getElementById('api-provider').value;
        localStorage.setItem('api_provider', apiProvider);
        // Сохраняем endpoint если выбран 'Другое'
        const apiEndpointInput = document.getElementById('api-endpoint');
        if (apiProvider === 'other') {
          localStorage.setItem('api_endpoint', apiEndpointInput.value.trim());
        } else {
          localStorage.removeItem('api_endpoint');
        }
        closeApikeyModal();
        e.preventDefault();
      }
    });

    // Кнопка "Оформить бронирование" (Привязать карту)
    const bookingBtn = document.getElementById('booking-btn');
    const paymentModal = document.getElementById('payment-modal');
    bookingBtn.onclick = () => {
      paymentModal.classList.add('active');
    };
    function closePaymentModal() {
      paymentModal.classList.remove('active');
    }
    // Скрыть модалку при старте (гарантированно)
    window.addEventListener('DOMContentLoaded', () => {
      paymentModal.classList.remove('active');
    });
    // Клик по тёмной подложке закрывает модалку
    paymentModal.addEventListener('mousedown', function(e) {
      if (e.target === paymentModal) {
        closePaymentModal();
      }
    });

    // Кнопка OK в apikey-float закрывает блок
    // Удаляю старую логику apikey-float и apikey-modal-backdrop

    // Telegram user info
    const tg = window.Telegram.WebApp;
    tg.ready();
    const chatbox = document.getElementById('chatbox');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');

    function appendAssistantGreeting() {
      let greeting = '';
      if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        const user = tg.initDataUnsafe.user;
        const name = user.first_name || user.last_name || user.username || 'Гость';
        greeting = `Привет, ${name}`;
      } else {
        greeting = 'Профиль пользователя не доступен';
      }
      const div = document.createElement('div');
      div.className = 'msg assistant';
      div.textContent = greeting;
      if (chatbox.firstChild) {
        chatbox.insertBefore(div, chatbox.firstChild);
      } else {
        chatbox.appendChild(div);
      }
    }
    appendAssistantGreeting();
    document.getElementById('user-info').style.display = 'none';

    userInput.addEventListener('keydown', function(e) {
      if (window.innerWidth > 600) {
        if (e.key === 'Enter' && !e.ctrlKey) {
          e.preventDefault();
          chatForm.requestSubmit();
        }
        // Ctrl+Enter — стандартный перенос строки
      }
    });
    // apiKeyInput теперь инициализируется внутри функций, чтобы всегда брать актуальный value

    // Available data files mapping
    const dataFiles = {
      'events-moscow': '/NOW/miniapp/events-moscow.json',
      'events-spb': '/NOW/miniapp/events-spb.json',
      'people-moscow': '/NOW/miniapp/people-moscow.json',
      'contractors-moscow': '/NOW/miniapp/contractors-moscow.json',
      'services-moscow': '/NOW/miniapp/services-moscow.json'
    };

    let currentData = {};
    let dataLoaded = false;
    let messages = [];
    let selectedItem = null; // Store selected booking item

    function appendMessage(role, content, bookingData = null) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      const textDiv = document.createElement('div');
      textDiv.textContent = (role === 'user' ? '' : '') + content;
      div.appendChild(textDiv);
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Gemini API endpoint
    const GEMINI_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

    // Функция для извлечения комментария GPT (объяснения), если он есть
    function extractGptComment(reply, items) {
      if (!reply) return '';
      let text = reply;
      // Удаляем все строки, которые содержат hash: <hash>
      const lines = text.split('\n');
      const hashPattern = /hash:\s*[a-fA-F0-9]{8,}/;
      const ignorePatterns = [
        /^\s*[-*•\d\.]+/, // markdown-списки, эмодзи, цифры
        /^\s*\*\*/, // жирные markdown
        /^\s*Описание:/i,
        /^\s*Место:/i,
        /^\s*Дата:/i,
        /^\s*Время:/i,
        /^\s*Цена:/i,
        /^\s*Контакт:/i,
        /^\s*Рейтинг:/i,
        /^\s*Услуга:/i,
        /^\s*Специализация:/i,
        /^\s*Опыт:/i
      ];
      let filtered = lines.filter(line => {
        if (!line.trim()) return false;
        if (hashPattern.test(line)) return false;
        if (ignorePatterns.some(re => re.test(line))) return false;
        if (Array.isArray(items)) {
          for (const item of items) {
            if (item.name && line.includes(item.name)) return false;
            if (item.description && line.includes(item.description)) return false;
            if (item.venue && line.includes(item.venue)) return false;
            if (item.price_range && line.includes(item.price_range)) return false;
            if (item.currency && line.includes(item.currency)) return false;
          }
        }
        return true;
      });
      const comment = filtered.join(' ').replace(/\s+/g, ' ').trim();
      if (comment.length > 10) return comment;
      return '';
    }

    // Фильтрация карточек по hash из ответа GPT
    function filterMentionedItemsByHash(items, replyText) {
      // Найти все hash: <hash> в ответе
      const hashes = Array.from(replyText.matchAll(/hash:\s*([a-fA-F0-9]{8,})/g)).map(m => m[1]);
      return items.filter(item => hashes.includes(item.hash));
    }

    // Рендер карточек с расширенной информацией
    function renderBookingCards(items) {
      // Больше не удаляем предыдущие карточки!
      // const oldCards = document.querySelectorAll('.booking-card');
      // oldCards.forEach(card => card.remove());
      // State: only one selected at a time
      let selectedCard = null;
      let selectedBookingItem = null;
      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'booking-card';
        card.style = 'background:#23272f;margin:1em 0;padding:1em;border-radius:18px;box-shadow:0 2px 8px #0004;position:relative;';
        let html = `<strong style="color:#7ecfff;">${item.name}</strong><br>`;
        if (item.venue) html += `Место: ${item.venue}<br>`;
        if (item.date) html += `Дата: ${item.date}<br>`;
        if (item.time) html += `Время: ${item.time}<br>`;
        if (item.price_range) html += `Цена: ${item.price_range} ${item.currency || 'RUB'}<br>`;
        if (item.specialization) html += `Специализация: ${item.specialization}<br>`;
        if (item.experience) html += `Опыт: ${item.experience}<br>`;
        if (item.rating) html += `Рейтинг: ${item.rating}<br>`;
        if (item.contact) html += `Контакт: ${item.contact}<br>`;
        if (item.description) html += `Описание: ${item.description}<br>`;
        card.innerHTML = html;
        // Кнопка "Выбрать"
        const selectBtn = document.createElement('button');
        selectBtn.className = 'booking-btn';
        selectBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z"/></svg>Выбрать';
        selectBtn.onclick = () => {
          document.querySelectorAll('.booking-card.selected').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedBookingItem = item;
          openBookingDetailsModal(item);
        };
        card.appendChild(selectBtn);
        // Удаляем кнопку "Забронировать"
        // (confirmBtn больше не нужен)
        document.getElementById('chatbox').appendChild(card);
      });
    }

    // Handle form submission
    chatForm.onsubmit = async (e) => {
      e.preventDefault();
      e.stopPropagation();

      // Получаем ключ, провайдера, endpoint и модель
      const apiKey = localStorage.getItem('api_key') || '';
      const apiProvider = localStorage.getItem('api_provider') || 'gemini';
      const apiEndpoint = localStorage.getItem('api_endpoint') || '';
      let apiModel = localStorage.getItem('api_model') || '';
      if (!apiModel) {
        // fallback по умолчанию
        if (apiProvider === 'groq') apiModel = 'llama-3-70b-8192';
        else if (apiProvider === 'mistral') apiModel = 'mistral-large-latest';
        else if (apiProvider === 'openai') apiModel = 'gpt-3.5-turbo';
        else if (apiProvider === 'deepseek') apiModel = 'deepseek-chat';
        else if (apiProvider === 'gemini') apiModel = 'gemini-2.0-flash';
      }

      const content = userInput.value.trim();
      if (!content) return;

      appendMessage('user', content);
      userInput.value = '';
      appendMessage('assistant', 'Определяю нужные данные...');

      try {
        // --- Определяем нужный файл через выбранное API ---
        let selectedFile = '';
        if (apiProvider === 'gemini') {
        const fileSelectionPrompt = `You are a data file selector. Based on the user's request, determine which JSON file should be loaded.\n\nAvailable files:\n- events-moscow.json (events in Moscow)\n- events-spb.json (events in Saint Petersburg) \n- people-moscow.json (professionals in Moscow)\n- contractors-moscow.json (construction/repair services in Moscow)\n- services-moscow.json (various services in Moscow)\n\nRespond ONLY with the filename (e.g., "events-moscow") without .json extension.`;
          const fileRes = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json; charset=utf-8'
          },
          body: JSON.stringify({
            contents: [
              { parts: [ { text: fileSelectionPrompt + "\n\n" + content } ] }
            ]
          })
        });
        const fileData = await fileRes.json();
        if (fileData.candidates && fileData.candidates[0] && fileData.candidates[0].content && fileData.candidates[0].content.parts && fileData.candidates[0].content.parts[0]) {
          selectedFile = fileData.candidates[0].content.parts[0].text.trim().toLowerCase();
          }
        } else if (apiProvider === 'openai') {
          // OpenAI prompt для выбора файла
          const fileSelectionPrompt = `You are a data file selector. Based on the user's request, determine which JSON file should be loaded.\n\nAvailable files:\n- events-moscow.json (events in Moscow)\n- events-spb.json (events in Saint Petersburg) \n- people-moscow.json (professionals in Moscow)\n- contractors-moscow.json (construction/repair services in Moscow)\n- services-moscow.json (various services in Moscow)\n\nRespond ONLY with the filename (e.g., "events-moscow") without .json extension.`;
          const fileRes = await throttledOpenAIFetchWithDots('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + apiKey,
              // 'OpenAI-Organization': 'org-Bl6DvczDSdIeSsrTrD7uPyaY', // можно добавить если нужно
            },
            body: JSON.stringify({
              model: apiModel,
              messages: [
                { role: 'system', content: fileSelectionPrompt },
                { role: 'user', content: content }
              ],
              max_tokens: 20,
              temperature: 0
            })
          }, false);
          const fileData = await fileRes.json();
          if (fileData.choices && fileData.choices[0] && fileData.choices[0].message && fileData.choices[0].message.content) {
            selectedFile = fileData.choices[0].message.content.trim().toLowerCase();
          }
        } else if (apiProvider === 'deepseek') {
          // DeepSeek prompt для выбора файла
          const fileSelectionPrompt = `You are a data file selector. Based on the user's request, determine which JSON file should be loaded.\n\nAvailable files:\n- events-moscow.json (events in Moscow)\n- events-spb.json (events in Saint Petersburg) \n- people-moscow.json (professionals in Moscow)\n- contractors-moscow.json (construction/repair services in Moscow)\n- services-moscow.json (various services in Moscow)\n\nRespond ONLY with the filename (e.g., "events-moscow") without .json extension.`;
          const fileRes = await fetchWithStatusLog('https://api.deepseek.com/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify({
              model: 'deepseek-chat',
              messages: [
                { role: 'system', content: fileSelectionPrompt },
                { role: 'user', content: content }
              ],
              stream: false,
              max_tokens: 20,
              temperature: 0
            })
          });
          const fileData = await fileRes.json();
          if (fileData.choices && fileData.choices[0] && fileData.choices[0].message && fileData.choices[0].message.content) {
            selectedFile = fileData.choices[0].message.content.trim().toLowerCase();
          }
        } else if (apiProvider === 'groq') {
          // Groq prompt для выбора файла
          const fileSelectionPrompt = `You are a data file selector. Based on the user's request, determine which JSON file should be loaded.\n\nAvailable files:\n- events-moscow.json (events in Moscow)\n- events-spb.json (events in Saint Petersburg) \n- people-moscow.json (professionals in Moscow)\n- contractors-moscow.json (construction/repair services in Moscow)\n- services-moscow.json (various services in Moscow)\n\nRespond ONLY with the filename (e.g., "events-moscow") without .json extension.`;
          const fileRes = await fetchWithStatusLog('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify({
              model: apiModel,
              messages: [
                { role: 'user', content: fileSelectionPrompt },
                { role: 'user', content: content }
              ],
              max_tokens: 20,
              temperature: 0
            })
          });
          const fileData = await fileRes.json();
          if (fileData.choices && fileData.choices[0] && fileData.choices[0].message && fileData.choices[0].message.content) {
            selectedFile = fileData.choices[0].message.content.trim().toLowerCase();
          }
        } else if (apiProvider === 'mistral') {
          // Mistral prompt для выбора файла
          const fileSelectionPrompt = `You are a data file selector. Based on the user's request, determine which JSON file should be loaded.\n\nAvailable files:\n- events-moscow.json (events in Moscow)\n- events-spb.json (events in Saint Petersburg) \n- people-moscow.json (professionals in Moscow)\n- contractors-moscow.json (construction/repair services in Moscow)\n- services-moscow.json (various services in Moscow)\n\nRespond ONLY with the filename (e.g., "events-moscow") without .json extension.`;
          const fileRes = await fetchWithStatusLog('https://api.mistral.ai/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify({
              model: 'mistral-large-latest',
              messages: [
                { role: 'user', content: fileSelectionPrompt },
                { role: 'user', content: content }
              ],
              max_tokens: 20,
              temperature: 0
            })
          });
          const fileData = await fileRes.json();
          if (fileData.choices && fileData.choices[0] && fileData.choices[0].message && fileData.choices[0].message.content) {
            selectedFile = fileData.choices[0].message.content.trim().toLowerCase();
          }
        } else if (apiProvider === 'other') {
          if (!apiEndpoint) {
            chatbox.removeChild(chatbox.lastChild);
            appendMessage('assistant', 'Пожалуйста, укажите endpoint для вашего API.');
            return;
          }
          // Для выбора файла — просто пропускаем, используем первый файл (или можно реализовать свою логику)
          selectedFile = Object.keys(dataFiles)[0];
        } else {
          chatbox.removeChild(chatbox.lastChild);
          appendMessage('assistant', 'Выбранный API не поддерживается.');
          return;
        }
        // Load the selected data file
        if (dataFiles[selectedFile]) {
          try {
            const dataRes = await fetch(dataFiles[selectedFile]);
            const text = await dataRes.text();
            if (!dataRes.ok) {
              const devtoolsMsg = `index.html:921 GET ${dataRes.url} ${dataRes.status} (${dataRes.statusText})`;
              console.error(devtoolsMsg + '\n' + (new Error().stack || '') + '\n' + text);
              // Логируем ошибку и только потом throw
              throw new Error(`HTTP ${dataRes.status}: ${dataRes.statusText}`);
            }
            let loadedData;
            try {
              loadedData = JSON.parse(text);
            } catch (jsonErr) {
              // Даже если парсинг не удался, devtoolsMsg уже залогирован выше
              console.error('Ошибка парсинга JSON при загрузке данных:', jsonErr, text);
              throw jsonErr;
            }
            currentData = loadedData;
            dataLoaded = true;
          } catch (dataError) {
            console.error('Ошибка загрузки данных:', dataError);
            chatbox.removeChild(chatbox.lastChild);
            appendMessage('assistant', 'Ошибка: ' + dataError.message);
            return;
          }
          chatbox.removeChild(chatbox.lastChild);
          // --- Основной ответ через выбранное API ---
          const systemPrompt = `You are an AI assistant for a comprehensive booking and service platform. You have access to the following data:\n\n${JSON.stringify(currentData, null, 2)}\n\nYour task is to help users with:\n- Booking events and venues\n- Finding professionals and experts\n- Hiring contractors for services\n- Accessing various local services\n\nIMPORTANT: For each suggested option, you MUST include its hash from the data (e.g., hash: abc123). For every option, write a line like: hash: <hash>.\n\nWhen the user confirms booking, respond as before.`;
          let reply = '';
          if (apiProvider === 'gemini') {
            const mainRes = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json; charset=utf-8'
            },
            body: JSON.stringify({
              contents: [
                { parts: [ { text: systemPrompt + "\n\n" + content } ] }
              ]
            })
          });
            const text = await mainRes.text();
            if (!mainRes.ok) {
              const devtoolsMsg = `index.html:1047 POST ${mainRes.url} ${mainRes.status} (${mainRes.statusText})`;
              console.error(devtoolsMsg + '\n' + (new Error().stack || '') + '\n' + text);
            }
            let mainData;
            try {
              mainData = JSON.parse(text);
            } catch (jsonErr) {
              // Даже если парсинг не удался, devtoolsMsg уже залогирован выше
              console.error('Ошибка парсинга JSON Gemini:', jsonErr, text);
              appendMessage('assistant', 'Ошибка: ' + jsonErr.message);
              return;
            }
          if (mainData.candidates && mainData.candidates[0] && mainData.candidates[0].content && mainData.candidates[0].content.parts && mainData.candidates[0].content.parts[0]) {
              reply = mainData.candidates[0].content.parts[0].text.trim();
            } else {
              console.error('Ошибка Gemini:', mainData.error || mainData);
              appendMessage('assistant', 'Ошибка: ' + (mainData.error?.message || 'Неизвестная ошибка'));
              return;
            }
          } else if (apiProvider === 'openai') {
            // Показываем "..." как ассистент typing
            let dotsDiv = document.createElement('div');
            dotsDiv.className = 'msg assistant';
            dotsDiv.textContent = '...';
            chatbox.appendChild(dotsDiv);
            chatbox.scrollTop = chatbox.scrollHeight;
            const mainRes = await throttledOpenAIFetchWithDots('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + apiKey,
                // 'OpenAI-Organization': 'org-Bl6DvczDSdIeSsrTrD7uPyaY', // можно добавить если нужно
              },
              body: JSON.stringify({
                model: apiModel,
                messages: [
                  { role: 'system', content: systemPrompt },
                  { role: 'user', content: content }
                ],
                max_tokens: 512,
                temperature: 0.7
              })
            }, true);
            const text = await mainRes.text();
            if (!mainRes.ok) {
              const devtoolsMsg = `index.html:1047 POST ${mainRes.url} ${mainRes.status} (${mainRes.statusText})`;
              console.error(devtoolsMsg + '\n' + (new Error().stack || '') + '\n' + text);
            }
            let mainData;
            try {
              mainData = JSON.parse(text);
            } catch (jsonErr) {
              // Даже если парсинг не удался, devtoolsMsg уже залогирован выше
              console.error('Ошибка парсинга JSON OpenAI:', jsonErr, text);
              dotsDiv.textContent = 'Ошибка: ' + jsonErr.message;
              return;
            }
            if (mainData.choices && mainData.choices[0] && mainData.choices[0].message && mainData.choices[0].message.content) {
              reply = mainData.choices[0].message.content.trim();
              // --- Единая обработка для всех моделей ---
              let mentionedItems = [];
              if (currentData.data && Array.isArray(currentData.data) && currentData.data.length > 0) {
                mentionedItems = filterMentionedItemsByHash(currentData.data, reply);
                let comment = extractGptComment(reply, mentionedItems);
                // Если есть комментарий — заменить ... на него, иначе оставить ...
                if (comment) {
                  dotsDiv.textContent = comment;
                } else if (mentionedItems.length === 0) {
                  dotsDiv.textContent = reply;
                }
                if (mentionedItems.length > 0) {
                  renderBookingCards(mentionedItems);
                }
              } else {
                dotsDiv.textContent = reply;
              }
            } else {
              console.error('Ошибка OpenAI:', mainData.error || mainData);
              dotsDiv.textContent = 'Ошибка: ' + (mainData.error?.message || 'Неизвестная ошибка');
              return;
            }
          } else if (apiProvider === 'deepseek') {
            const mainRes = await fetch('https://api.deepseek.com/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + apiKey
              },
              body: JSON.stringify({
                model: 'deepseek-chat',
                messages: [
                  { role: 'system', content: systemPrompt },
                  { role: 'user', content: content }
                ],
                max_tokens: 512,
                temperature: 0.7,
                stream: false
              })
            });
            const text = await mainRes.text();
            if (!mainRes.ok) {
              const devtoolsMsg = `index.html:1047 POST ${mainRes.url} ${mainRes.status} (${mainRes.statusText})`;
              console.error(devtoolsMsg + '\n' + (new Error().stack || '') + '\n' + text);
            }
            let mainData;
            try {
              mainData = JSON.parse(text);
            } catch (jsonErr) {
              // Даже если парсинг не удался, devtoolsMsg уже залогирован выше
              console.error('Ошибка парсинга JSON DeepSeek:', jsonErr, text);
              appendMessage('assistant', 'Ошибка: ' + jsonErr.message);
              return;
            }
            if (mainData.choices && mainData.choices[0] && mainData.choices[0].message && mainData.choices[0].message.content) {
              reply = mainData.choices[0].message.content.trim();
            } else {
              console.error('Ошибка DeepSeek:', mainData.error || mainData);
              appendMessage('assistant', 'Ошибка: ' + (mainData.error?.message || 'Неизвестная ошибка'));
              return;
            }
          } else if (apiProvider === 'groq') {
            const mainRes = await fetchWithStatusLog('https://api.groq.com/openai/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + apiKey
              },
              body: JSON.stringify({
                model: apiModel,
                messages: [
                  { role: 'system', content: systemPrompt },
                  { role: 'user', content: content }
                ],
                max_tokens: 512,
                temperature: 0.7
              })
            });
            const text = await mainRes.text();
            if (!mainRes.ok) {
              const devtoolsMsg = `index.html:1047 POST ${mainRes.url} ${mainRes.status} (${mainRes.statusText})`;
              console.error(devtoolsMsg + '\n' + (new Error().stack || '') + '\n' + text);
            }
            let mainData;
            try {
              mainData = JSON.parse(text);
            } catch (jsonErr) {
              console.error('Ошибка парсинга JSON Groq:', jsonErr, text);
              appendMessage('assistant', 'Ошибка: ' + jsonErr.message);
              return;
            }
            if (mainData.choices && mainData.choices[0] && mainData.choices[0].message && mainData.choices[0].message.content) {
              reply = mainData.choices[0].message.content.trim();
            } else {
              console.error('Ошибка Groq:', mainData.error || mainData);
              appendMessage('assistant', 'Ошибка: ' + (mainData.error?.message || 'Неизвестная ошибка'));
              return;
            }
          } else if (apiProvider === 'mistral') {
            const mainRes = await fetchWithStatusLog('https://api.mistral.ai/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': 'Bearer ' + apiKey
              },
              body: JSON.stringify({
                model: 'mistral-large-latest',
                messages: [
                  { role: 'system', content: systemPrompt },
                  { role: 'user', content: content }
                ],
                max_tokens: 512,
                temperature: 0.7
              })
            });
            const text = await mainRes.text();
            if (!mainRes.ok) {
              const devtoolsMsg = `index.html:1047 POST ${mainRes.url} ${mainRes.status} (${mainRes.statusText})`;
              console.error(devtoolsMsg + '\n' + (new Error().stack || '') + '\n' + text);
            }
            let mainData;
            try {
              mainData = JSON.parse(text);
            } catch (jsonErr) {
              console.error('Ошибка парсинга JSON Mistral:', jsonErr, text);
              appendMessage('assistant', 'Ошибка: ' + jsonErr.message);
              return;
            }
            if (mainData.choices && mainData.choices[0] && mainData.choices[0].message && mainData.choices[0].message.content) {
              reply = mainData.choices[0].message.content.trim();
            } else {
              console.error('Ошибка Mistral:', mainData.error || mainData);
              appendMessage('assistant', 'Ошибка: ' + (mainData.error?.message || 'Неизвестная ошибка'));
              return;
            }
          } else if (apiProvider === 'other') {
            if (!apiEndpoint) {
              appendMessage('assistant', 'Пожалуйста, укажите endpoint для вашего API.');
              return;
            }
            // Пример запроса к произвольному endpoint (POST, JSON)
            try {
              const mainRes = await fetch(apiEndpoint, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + apiKey
                },
                body: JSON.stringify({
                  prompt: systemPrompt + "\n\n" + content
                })
              });
              const text = await mainRes.text();
              if (!mainRes.ok) {
                const devtoolsMsg = `index.html:1047 POST ${mainRes.url} ${mainRes.status} (${mainRes.statusText})`;
                console.error(devtoolsMsg + '\n' + (new Error().stack || '') + '\n' + text);
              }
              let mainData;
              try {
                mainData = JSON.parse(text);
              } catch (jsonErr) {
                // Даже если парсинг не удался, devtoolsMsg уже залогирован выше
                console.error('Ошибка парсинга JSON Other API:', jsonErr, text);
                appendMessage('assistant', 'Ошибка: ' + jsonErr.message);
                return;
              }
              // Попытка получить текст из разных возможных полей
              reply = mainData.choices?.[0]?.text || mainData.choices?.[0]?.message?.content || mainData.result || JSON.stringify(mainData);
            } catch (err) {
              console.error('Ошибка Other API:', err);
              appendMessage('assistant', 'Ошибка при обращении к вашему API: ' + err.message);
              return;
            }
          } else {
            appendMessage('assistant', 'Выбранный API не поддерживается.');
            return;
          }
            let mentionedItems = [];
            if (currentData.data && Array.isArray(currentData.data) && currentData.data.length > 0) {
              mentionedItems = filterMentionedItemsByHash(currentData.data, reply);
              let comment = extractGptComment(reply, mentionedItems);
              if (comment) {
                appendMessage('assistant', comment, null);
              }
              if (mentionedItems.length > 0) {
                renderBookingCards(mentionedItems);
              }
          }
        } else {
          chatbox.removeChild(chatbox.lastChild);
          appendMessage('assistant', `Не удалось определить нужные данные (${selectedFile}). Попробуйте переформулировать запрос.`);
        }
      } catch (err) {
        chatbox.removeChild(chatbox.lastChild);
        console.error('index.html:1047 Ошибка в chatForm.onsubmit:', err, err?.stack);
        appendMessage('assistant', 'Ошибка: ' + err.message);
      }
    };

    // (Удалён отдельный обработчик send-btn, теперь отправка только через submit формы)

    // Payment logic (оставьте как было)
    // ... ваш код оплаты и закрытия модального окна ...
    // Скрывать клавиатуру на телефоне при клике вне input
    document.addEventListener('touchstart', function(e) {
      const inputRow = document.querySelector('.input-row');
      if (!inputRow.contains(e.target)) {
        userInput.blur();
      }
    });
    document.addEventListener('mousedown', function(e) {
      // Для десктопа — тоже снимаем фокус
      const inputRow = document.querySelector('.input-row');
      if (!inputRow.contains(e.target)) {
        userInput.blur();
      }
    });

    // --- Booking Details Modal logic ---
    const bookingDetailsModal = document.getElementById('booking-details-modal');
    const bookingDetailsContent = document.getElementById('booking-details-content');
    const bookingAgreeCheckbox = document.getElementById('booking-agree-checkbox');
    const bookingConfirmBtn = document.getElementById('booking-confirm-btn');
    function openBookingDetailsModal(item) {
      // Заполнить детали
      let html = `<strong style='color:#7ecfff;font-size:1.15em;'>${item.name}</strong><br>`;
      if (item.venue) html += `Место: ${item.venue}<br>`;
      if (item.date) html += `Дата: ${item.date}<br>`;
      if (item.time) html += `Время: ${item.time}<br>`;
      if (item.price_range) html += `Цена: ${item.price_range} ${item.currency || 'RUB'}<br>`;
      if (item.specialization) html += `Специализация: ${item.specialization}<br>`;
      if (item.experience) html += `Опыт: ${item.experience}<br>`;
      if (item.rating) html += `Рейтинг: ${item.rating}<br>`;
      if (item.contact) html += `Контакт: ${item.contact}<br>`;
      if (item.description) html += `Описание: ${item.description}<br>`;
      bookingDetailsContent.innerHTML = html;
      bookingAgreeCheckbox.checked = false;
      bookingConfirmBtn.disabled = true;
      bookingDetailsModal.classList.add('active');
    }
    function closeBookingDetailsModal() {
      bookingDetailsModal.classList.remove('active');
    }
    bookingAgreeCheckbox.addEventListener('change', function() {
      bookingConfirmBtn.disabled = !this.checked;
    });
    bookingConfirmBtn.onclick = function() {
      closeBookingDetailsModal();
      // Можно добавить дальнейшую логику подтверждения бронирования
      appendMessage('assistant', 'Спасибо! Ваша заявка на бронирование отправлена. Ожидайте подтверждения.');
    };
    // Клик по тёмной подложке закрывает модалку
    bookingDetailsModal.addEventListener('mousedown', function(e) {
      if (e.target === bookingDetailsModal) {
        closeBookingDetailsModal();
      }
    });

    // --- Demo Fetch API with error handling ---
    // (удалено)

    // Обновление списка моделей при смене провайдера
    function updateModelOptions(provider, selectedModel) {
      let options = [];
      if (provider === 'groq') {
        options = [
          {id: 'llama-3-70b-8192', name: 'llama-3-70b-8192'},
          {id: 'llama-3-8b-8192', name: 'llama-3-8b-8192'},
          {id: 'llama-3.1-8b-instant', name: 'llama-3.1-8b-instant'},
          {id: 'llama-3.3-70b-versatile', name: 'llama-3.3-70b-versatile'},
          {id: 'distil-whisper-large-v3-en', name: 'distil-whisper-large-v3-en'},
          {id: 'gemma2-9b-it', name: 'gemma2-9b-it'},
          {id: 'meta-llama/llama-guard-4-12b', name: 'meta-llama/llama-guard-4-12b'},
          {id: 'whisper-large-v3', name: 'whisper-large-v3'},
          {id: 'whisper-large-v3-turbo', name: 'whisper-large-v3-turbo'},
          {id: 'deepseek-r1-distill-llama-70b', name: 'deepseek-r1-distill-llama-70b'},
          {id: 'meta-llama/llama-4-maverick-17b-128e-instruct', name: 'meta-llama/llama-4-maverick-17b-128e-instruct'},
          {id: 'meta-llama/llama-4-scout-17b-16e-instruct', name: 'meta-llama/llama-4-scout-17b-16e-instruct'},
          {id: 'meta-llama/llama-prompt-guard-2-22m', name: 'meta-llama/llama-prompt-guard-2-22m'},
          {id: 'meta-llama/llama-prompt-guard-2-86m', name: 'meta-llama/llama-prompt-guard-2-86m'},
          {id: 'mistral-saba-24b', name: 'mistral-saba-24b'},
          {id: 'moonshotai/kimi-k2-instruct', name: 'moonshotai/kimi-k2-instruct'},
          {id: 'playai-tts', name: 'playai-tts'},
          {id: 'playai-tts-arabic', name: 'playai-tts-arabic'},
          {id: 'qwen/qwen3-32b', name: 'qwen/qwen3-32b'},
          {id: 'other', name: 'Другая...'}
        ];
      } else if (provider === 'mistral') {
        options = [
          {id: 'mistral-large-latest', name: 'mistral-large-latest'},
          {id: 'other', name: 'Другая...'}
        ];
      } else if (provider === 'openai') {
        options = [
          {id: 'gpt-4.1', name: 'gpt-4.1'},
          {id: 'gpt-4.1-mini', name: 'gpt-4.1-mini'},
          {id: 'gpt-4.1-nano', name: 'gpt-4.1-nano'},
          {id: 'gpt-3.5-turbo', name: 'gpt-3.5-turbo'},
          {id: 'gpt-3.5-turbo-16k', name: 'gpt-3.5-turbo-16k'},
          {id: 'gpt-3.5-turbo-0125', name: 'gpt-3.5-turbo-0125'},
          {id: 'gpt-3.5-turbo-1106', name: 'gpt-3.5-turbo-1106'},
          {id: 'gpt-3.5-turbo-instruct', name: 'gpt-3.5-turbo-instruct'},
          {id: 'gpt-3.5-turbo-instruct-0914', name: 'gpt-3.5-turbo-instruct-0914'},
          {id: 'gpt-4o', name: 'gpt-4o'},
          {id: 'gpt-4o-mini', name: 'gpt-4o-mini'},
          {id: 'o1-preview', name: 'o1-preview'},
          {id: 'o3', name: 'o3'},
          {id: 'o3-mini', name: 'o3-mini'},
          {id: 'o3-pro', name: 'o3-pro'},
          {id: 'o4-mini', name: 'o4-mini'},
          {id: 'other', name: 'Другая...'}
        ];
      } else if (provider === 'deepseek') {
        options = [
          {id: 'deepseek-chat', name: 'deepseek-chat'},
          {id: 'other', name: 'Другая...'}
        ];
      } else if (provider === 'gemini') {
        options = [
          {id: 'gemini-2.0-flash', name: 'gemini-2.0-flash'},
          {id: 'other', name: 'Другая...'}
        ];
      } else {
        options = [
          {id: 'other', name: 'Другая...'}
        ];
      }
      apiModelSelect.innerHTML = '';
      options.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt.id;
        o.textContent = opt.name;
        apiModelSelect.appendChild(o);
      });
      // Выбрать сохранённую или первую
      if (selectedModel && options.some(opt => opt.id === selectedModel)) {
        apiModelSelect.value = selectedModel;
      } else {
        apiModelSelect.value = options[0].id;
      }
      // Показать/скрыть input для custom model
      if (apiModelSelect.value === 'other') {
        apiModelCustom.style.display = '';
        apiModelCustom.value = selectedModel && selectedModel !== 'other' ? selectedModel : '';
      } else {
        apiModelCustom.style.display = 'none';
      }
    }
    // При смене провайдера — обновить список моделей
    document.getElementById('api-provider').addEventListener('change', function() {
      updateModelOptions(this.value, '');
      const apiEndpointWrap = document.getElementById('api-endpoint-wrap');
      if (this.value === 'other') {
        apiEndpointWrap.style.display = '';
      } else {
        apiEndpointWrap.style.display = 'none';
      }
    });
    // При смене модели — показать input если выбрана "Другая"
    apiModelSelect.addEventListener('change', function() {
      if (this.value === 'other') {
        apiModelCustom.style.display = '';
        apiModelCustom.value = '';
        apiModelCustom.focus();
      } else {
        apiModelCustom.style.display = 'none';
      }
    });

    // --- Глобальный троттлинг для OpenAI с индикатором "..." ---
    let lastOpenAIRequestTime = 0;
    const OPENAI_MIN_DELAY = 3000; // 3 секунды
    let isFirstOpenAIRequest = true;
    async function throttledOpenAIFetchWithDots(url, options, showLoadingDots) {
      const now = Date.now();
      let wait = 0;
      if (isFirstOpenAIRequest) {
        isFirstOpenAIRequest = false;
        lastOpenAIRequestTime = now;
      } else {
        wait = Math.max(0, OPENAI_MIN_DELAY - (now - lastOpenAIRequestTime));
        if (wait > 0 && showLoadingDots) {
          await new Promise(res => setTimeout(res, wait));
        }
        lastOpenAIRequestTime = Date.now();
      }
      return fetchWithStatusLog(url, options);
    }

    // --- Кнопки очистки и вставки API Key ---
    document.getElementById('api-key-clear-btn').onclick = function() {
      document.getElementById('api-key').value = '';
      document.getElementById('api-key').focus();
    };
    document.getElementById('api-key-paste-btn').onclick = async function() {
      try {
        const text = await navigator.clipboard.readText();
        document.getElementById('api-key').value = text;
        document.getElementById('api-key').focus();
      } catch (e) {
        alert('Не удалось получить данные из буфера обмена.');
      }
    };
  </script>
</body>
</html>
