<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram Mini App v1.53</title>
  <style>
    body { font-family: 'Inter', Arial, sans-serif; background: #f9f9f9; color: #222; margin: 0; padding: 0; }
    .container { max-width: 400px; margin: 2em auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.07); padding: 2em; text-align: center; }
    h1 { color: #0088cc; }
    .user { margin: 1.5em 0; font-size: 1.1em; }
    .apikey { margin-bottom: 1em; }
    .apikey input { width: 80%; padding: 0.5em; border-radius: 4px; border: 1px solid #ccc; }
    .chatbox { background: #f5f5f5; border-radius: 8px; padding: 1em; height: 200px; overflow-y: auto; text-align: left; margin-bottom: 1em; font-size: 0.98em; }
    .msg.user { color: #0088cc; font-weight: 600; }
    .msg.assistant { color: #222; }
    .msg { margin-bottom: 0.7em; }
    .input-row { display: flex; gap: 0.5em; }
    .input-row input { flex: 1; padding: 0.5em; border-radius: 4px; border: 1px solid #ccc; }
    .input-row button { background: #0088cc; color: #fff; border: none; border-radius: 4px; padding: 0.5em 1.2em; font-weight: 700; cursor: pointer; transition: background 0.2s; }
    .input-row button:hover { background: #005f7a; }
    .miniapp-btn { background: #0088cc; color: #fff; border: none; border-radius: 6px; padding: 1em 2em; font-size: 1.1em; font-weight: 700; cursor: pointer; margin-top: 2em; transition: background 0.2s; }
    .miniapp-btn:hover { background: #005f7a; }
    .booking-btn { background: #28a745; color: #fff; border: none; border-radius: 4px; padding: 0.5em 1em; font-weight: 600; cursor: pointer; margin: 0.5em 0; transition: background 0.2s; }
    .booking-btn:hover { background: #218838; }
    .payment-form { background: #f8f9fa; border-radius: 8px; padding: 1em; margin: 1em 0; display: none; }
    .payment-form input { width: 100%; padding: 0.5em; margin: 0.5em 0; border-radius: 4px; border: 1px solid #ccc; }
    .payment-form button { background: #dc3545; color: #fff; border: none; border-radius: 4px; padding: 0.5em 1em; font-weight: 600; cursor: pointer; margin: 0.5em 0; transition: background 0.2s; }
    .payment-form button:hover { background: #c82333; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1000; }
    .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2em; border-radius: 12px; max-width: 90%; max-height: 80%; overflow-y: auto; }
    .modal-close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #666; }
    .modal-close:hover { color: #000; }
  </style>
</head>
<body>
  <div class="container"> 
    <h1>NOW v2.13</h1>
    <div class="user" id="user-info">Loading user info...</div>
    <!-- –£–¥–∞–ª—ë–Ω –±–ª–æ–∫ –≤–≤–æ–¥–∞ API-–∫–ª—é—á–∞ -->
    <div class="chatbox" id="chatbox"></div>
    <form id="chat-form" class="input-row" autocomplete="off" onsubmit="return false;">
      <input type="text" id="user-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–±—Ä–æ–Ω–∏—Ä—É–π —Å—Ç–æ–ª–∏–∫ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ –Ω–∞ –≤–µ—á–µ—Ä" required />
      <button type="button" id="send-btn">Send</button>
    </form>
    
    <!-- Payment Modal -->
    <div class="modal" id="payment-modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closePaymentModal()">&times;</span>
        <h3>üí≥ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <div id="modal-booking-details"></div>
        <div style="margin: 1em 0;">
          <input type="text" id="card-number" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: 1234 5678 9012 3456" maxlength="19" />
          <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5" />
          <input type="text" id="card-cvv" placeholder="CVV" maxlength="3" />
          <input type="text" id="card-name" placeholder="–ò–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–∞—Ä—Ç—ã" />
        </div>
        <button type="button" id="pay-btn" style="width: 100%;">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å</button>
      </div>
    </div>
    
    <button class="miniapp-btn" id="close-btn">Close Mini App</button>
  </div>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // Telegram user info
    const tg = window.Telegram.WebApp;
    tg.ready();
    const userInfo = document.getElementById('user-info');
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
      const user = tg.initDataUnsafe.user;
      userInfo.textContent = `Hello, ${user.first_name} ${user.last_name || ''} (@${user.username || 'no username'})!`;
    } else {
      userInfo.textContent = 'User info not available.';
    }
    
    // Get DOM elements
    const chatbox = document.getElementById('chatbox');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const apiKeyInput = document.getElementById('api-key');
    
    // Available data files mapping
    const dataFiles = {
      'events-moscow': '/NOW/miniapp/events-moscow.json',
      'events-spb': '/NOW/miniapp/events-spb.json',
      'people-moscow': '/NOW/miniapp/people-moscow.json',
      'contractors-moscow': '/NOW/miniapp/contractors-moscow.json',
      'services-moscow': '/NOW/miniapp/services-moscow.json'
    };
    
    let currentData = {};
    let dataLoaded = false;
    let messages = [];
    let selectedItem = null; // Store selected booking item
    
    function appendMessage(role, content, bookingData = null) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      
      // Create text content
      const textDiv = document.createElement('div');
      textDiv.textContent = (role === 'user' ? 'You: ' : 'Assistant: ') + content;
      div.appendChild(textDiv);
      
      // Add booking button if this is an assistant message with booking data
      console.log('appendMessage called with:', { role, content: content.substring(0, 50) + '...', bookingData });
      
      if (role === 'assistant' && bookingData) {
        console.log('Creating booking button for:', bookingData.name);
        const bookingBtn = document.createElement('button');
        bookingBtn.className = 'booking-btn';
        bookingBtn.textContent = `üí≥ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞ ${bookingData.price_range || '—É–∫–∞–∑–∞–Ω–Ω—É—é'} ${bookingData.currency || 'RUB'}`;
        bookingBtn.onclick = () => showPaymentForm(bookingData);
        div.appendChild(bookingBtn);
      } else if (role === 'assistant') {
        console.log('Assistant message but no booking data');
      }
      
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight;
    }
    
    function showPaymentForm(item) {
      selectedItem = item;
      const paymentForm = document.getElementById('payment-form');
      const bookingDetails = document.getElementById('booking-details');
      
      // Show booking details
      let details = `<strong>${item.name}</strong><br>`;
      if (item.venue) details += `–ú–µ—Å—Ç–æ: ${item.venue}<br>`;
      if (item.date) details += `–î–∞—Ç–∞: ${item.date}<br>`;
      if (item.time) details += `–í—Ä–µ–º—è: ${item.time}<br>`;
      if (item.price_range) details += `–¶–µ–Ω–∞: ${item.price_range} ${item.currency || 'RUB'}<br>`;
      if (item.description) details += `–û–ø–∏—Å–∞–Ω–∏–µ: ${item.description}`;
      
      bookingDetails.innerHTML = details;
      paymentForm.style.display = 'block';
      
      // Scroll to payment form
      paymentForm.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Gemini API key (hardcoded as per user request)
    const GEMINI_API_KEY = 'AIzaSyAWRejhuWkpCbboRiXza2TqQRI6NGSvAuk';
    const GEMINI_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
    
    // Handle form submission
    chatForm.onsubmit = async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('Form submitted, preventing default behavior');
      
      // No need for API key input, using Gemini key
      // const apiKey = apiKeyInput.value.trim();
      // if (!apiKey) {
      //   alert('Please enter your OpenAI API key.');
      //   return;
      // }
      
      const content = userInput.value.trim();
      if (!content) return;
      
      appendMessage('user', content);
      userInput.value = '';
      appendMessage('assistant', '–û–ø—Ä–µ–¥–µ–ª—è—é –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...');
      
      try {
        console.log('=== STARTING REQUEST ===');
        console.log('User input:', content);
        
        // First, ask Gemini to determine which data file is needed
        const fileSelectionPrompt = `You are a data file selector. Based on the user's request, determine which JSON file should be loaded.\n\nAvailable files:\n- events-moscow.json (events in Moscow)\n- events-spb.json (events in Saint Petersburg) \n- people-moscow.json (professionals in Moscow)\n- contractors-moscow.json (construction/repair services in Moscow)\n- services-moscow.json (various services in Moscow)\n\nRespond ONLY with the filename (e.g., \"events-moscow\") without .json extension.`;
        
        // Gemini file selection request
        const fileRes = await fetch(GEMINI_ENDPOINT + '?key=' + GEMINI_API_KEY, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json; charset=utf-8'
          },
          body: JSON.stringify({
            contents: [
              { role: 'user', parts: [ { text: fileSelectionPrompt } ] },
              { role: 'user', parts: [ { text: content } ] }
            ]
          })
        });
        
        const fileData = await fileRes.json();
        console.log('Gemini file selection response:', fileData);
        let selectedFile = '';
        if (fileData.candidates && fileData.candidates[0] && fileData.candidates[0].content && fileData.candidates[0].content.parts && fileData.candidates[0].content.parts[0]) {
          selectedFile = fileData.candidates[0].content.parts[0].text.trim().toLowerCase();
          console.log('Selected file:', selectedFile);
        } else {
          console.error('File selection failed:', fileData);
        }
        // Load the selected data file
        if (dataFiles[selectedFile]) {
          try {
            const dataRes = await fetch(dataFiles[selectedFile]);
            if (!dataRes.ok) {
              throw new Error(`HTTP ${dataRes.status}: ${dataRes.statusText}`);
            }
            const loadedData = await dataRes.json();
            currentData = loadedData;
            dataLoaded = true;
            console.log('Data loaded successfully:', currentData);
          } catch (dataError) {
            console.error('Error loading data file:', dataError);
            throw dataError;
          }
          chatbox.removeChild(chatbox.lastChild);
          // Now create the main response with loaded data
          const systemPrompt = `You are an AI assistant for a comprehensive booking and service platform. You have access to the following data:\n\n${JSON.stringify(currentData, null, 2)}\n\nYour task is to help users with:\n- Booking events and venues\n- Finding professionals and experts\n- Hiring contractors for services\n- Accessing various local services\n\nIMPORTANT: When a user confirms they want to book something (says \"–¥–∞\", \"—Ö–æ—á—É\", \"–±—Ä–æ–Ω–∏—Ä—É—é\", \"–≤—ã–±–∏—Ä–∞—é\", \"–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é\", etc.), you MUST respond with:\n1. A confirmation message\n2. The exact item ID from the data (e.g., \"m1\", \"sp2\", \"mp1\", etc.)\n3. Start your response with \"BOOKING_CONFIRMED:\" followed by the item ID\n\nExample: \"BOOKING_CONFIRMED:m1 - –û—Ç–ª–∏—á–Ω–æ! –ë—Ä–æ–Ω–∏—Ä—É—é –¥–ª—è –≤–∞—Å –∫–æ–Ω—Ü–µ—Ä—Ç –≥—Ä—É–ø–ø—ã '–í—Ä–µ–º—è'...\"\n\nProvide detailed, helpful responses based on the available data. Include prices, contact information, and relevant details.`;
          // Gemini main response request
          const mainRes = await fetch(GEMINI_ENDPOINT + '?key=' + GEMINI_API_KEY, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json; charset=utf-8'
            },
            body: JSON.stringify({
              contents: [
                { role: 'user', parts: [ { text: systemPrompt } ] },
                { role: 'user', parts: [ { text: content } ] }
              ]
            })
          });
          const mainData = await mainRes.json();
          console.log('Gemini main response:', mainData);
          if (mainData.candidates && mainData.candidates[0] && mainData.candidates[0].content && mainData.candidates[0].content.parts && mainData.candidates[0].content.parts[0]) {
            const reply = mainData.candidates[0].content.parts[0].text.trim();
            appendMessage('assistant', reply, null);
            messages.push({role: 'user', content});
            messages.push({role: 'assistant', content: reply});
            if (currentData.data && Array.isArray(currentData.data) && currentData.data.length > 0) {
              renderBookingCards(currentData.data);
            }
          } else {
            console.error('Main response failed:', mainData);
            appendMessage('assistant', '–û—à–∏–±–∫–∞: ' + (mainData.error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        } else {
          chatbox.removeChild(chatbox.lastChild);
          appendMessage('assistant', `–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (${selectedFile}). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å.`);
        }
      } catch (err) {
        console.error('=== ERROR OCCURRED ===');
        console.error('Error type:', err.name);
        console.error('Error message:', err.message);
        console.error('Error stack:', err.stack);
        chatbox.removeChild(chatbox.lastChild);
        appendMessage('assistant', '–û—à–∏–±–∫–∞: ' + err.message);
      }
    };
    
    // Handle send button click
    document.getElementById('send-btn').onclick = async () => {
      // Just trigger the form submit
      chatForm.onsubmit(new Event('submit'));
    };
    
    // Handle payment
    document.getElementById('pay-btn').onclick = async () => {
      if (!selectedItem) {
        alert('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
        return;
      }
      
      const cardNumber = document.getElementById('card-number').value;
      const cardExpiry = document.getElementById('card-expiry').value;
      const cardCvv = document.getElementById('card-cvv').value;
      const cardName = document.getElementById('card-name').value;
      
      if (!cardNumber || !cardExpiry || !cardCvv || !cardName) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }
      
      // Simulate payment processing
      const payBtn = document.getElementById('pay-btn');
      payBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
      payBtn.disabled = true;
      
      setTimeout(async () => {
        // Simulate successful payment
        payBtn.textContent = '–û–ø–ª–∞—á–µ–Ω–æ!';
        payBtn.style.background = '#28a745';
        
        // Send booking data to Telegram bot
        const bookingInfo = {
          user: tg.initDataUnsafe?.user || {},
          item: selectedItem,
          payment: {
            cardNumber: cardNumber.slice(-4), // Only last 4 digits for security
            cardName: cardName
          },
          timestamp: new Date().toISOString()
        };
        
        console.log('Sending booking to Telegram bot:', bookingInfo);
        
        // Send data to Telegram bot
        tg.sendData(JSON.stringify(bookingInfo));
        
        // Show success message
        appendMessage('assistant', '‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ! –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–æ—Ç.');
        
        // Hide payment modal
        closePaymentModal();
        
        // Reset form
        document.getElementById('card-number').value = '';
        document.getElementById('card-expiry').value = '';
        document.getElementById('card-cvv').value = '';
        document.getElementById('card-name').value = '';
        
        // Reset button
        setTimeout(() => {
          payBtn.textContent = '–û–ø–ª–∞—Ç–∏—Ç—å';
          payBtn.disabled = false;
          payBtn.style.background = '#dc3545';
        }, 2000);
        
      }, 2000);
    };
    
    // Close Mini App
    document.getElementById('close-btn').onclick = function() {
      tg.close();
    };

    // Render booking cards for all items with selection logic
    function renderBookingCards(items) {
      // Remove previous cards
      const oldCards = document.querySelectorAll('.booking-card');
      oldCards.forEach(card => card.remove());
      // State: only one selected at a time
      let selectedCard = null;
      let selectedBookingItem = null;
      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'booking-card';
        card.style = 'background:#f8f9fa;margin:1em 0;padding:1em;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.04);position:relative;';
        let html = `<strong style=\"color:#0088cc;\">${item.name}</strong><br>`;
        if (item.venue) html += `–ú–µ—Å—Ç–æ: ${item.venue}<br>`;
        if (item.date) html += `–î–∞—Ç–∞: ${item.date}<br>`;
        if (item.time) html += `–í—Ä–µ–º—è: ${item.time}<br>`;
        if (item.price_range) html += `–¶–µ–Ω–∞: ${item.price_range} ${item.currency || 'RUB'}<br>`;
        if (item.description) html += `–û–ø–∏—Å–∞–Ω–∏–µ: ${item.description}<br>`;
        card.innerHTML = html;
        // –í—ã–±—Ä–∞—Ç—å
        const selectBtn = document.createElement('button');
        selectBtn.className = 'booking-btn';
        selectBtn.textContent = '–í—ã–±—Ä–∞—Ç—å';
        selectBtn.onclick = () => {
          // –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö
          document.querySelectorAll('.booking-card.selected').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedBookingItem = item;
          // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
          document.querySelectorAll('.booking-card .confirm-btn').forEach(b => b.style.display = 'none');
          confirmBtn.style.display = 'inline-block';
        };
        card.appendChild(selectBtn);
        // –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞)
        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'booking-btn confirm-btn';
        confirmBtn.style.background = '#28a745';
        confirmBtn.style.display = 'none';
        confirmBtn.textContent = `üí≥ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å${item.price_range ? ' –∑–∞ ' + item.price_range + ' ' + (item.currency || 'RUB') : ''}`;
        confirmBtn.onclick = () => showPaymentForm(item);
        card.appendChild(confirmBtn);
        document.getElementById('chatbox').appendChild(card);
      });
    }
    // Add highlight for selected card
    const style = document.createElement('style');
    style.innerHTML = `.booking-card.selected { border: 2px solid #28a745; box-shadow: 0 0 0 2px #28a74533; }`;
    document.head.appendChild(style);
  </script>
</body>
</html>
