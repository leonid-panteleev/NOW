<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram Mini App</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap&subset=cyrillic" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=add_card,key_vertical,send" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geologica:wght@100..900&family=Martian+Mono:wght@100..800&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #181c22;
      color: #fff;
      font-family: 'Geologica', sans-serif;
      font-optical-sizing: auto;
      font-variation-settings: "slnt" 0, "CRSV" 0, "SHRP" 0;
      font-weight: 300;
      box-sizing: border-box;
    }
    *, *:before, *:after {
      box-sizing: inherit;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
      overflow-x: hidden;
      overflow-y: hidden;
      background: #181c22;
    }
    .container {
      width: 100vw;
      max-width: 100vw;
      height: 100vh;
      max-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #181c22;
      box-shadow: none;
      border-radius: 0;
      padding: 0;
      box-sizing: border-box;
      position: relative;
    }
    .header {
      width: 100vw;
      max-width: 100vw;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5em 2em 1em 2em;
      min-height: 72px;
      box-sizing: border-box;
      background: #1a1d21;
      z-index: 1002;
      border-bottom: 1.5px solid #23272f;
      box-shadow: 0 2px 16px #0004;
      position: relative;
    }
    .app-title {
      font-size: 1.45em;
      font-weight: 700;
      color: #fff;
      letter-spacing: 1.5px;
      display: flex;
      align-items: center;
      gap: 0.5em;
      text-shadow: 0 2px 8px #0006;
      user-select: none;
    }
    .app-title .logo {
      font-size: 1.25em;
      margin-right: 0.3em;
      filter: drop-shadow(0 2px 4px #0008);
    }
    .header > div {
      display: flex; gap: 0.7em; align-items: center;
      margin-left: 1.2em;
    }
    .header-icon {
      font-size: 1.35em;
      filter: drop-shadow(0 2px 4px #0008);
      vertical-align: middle;
      pointer-events: none;
      user-select: none;
    }
    .key-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #23272f;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px #0003;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }
    .key-btn:hover {
      background: #2d323b;
    }
    .key-btn svg {
      width: 22px;
      height: 22px;
      fill: #7ecfff;
    }
    /* –£–¥–∞–ª—è—é .apikey-float –∏ .apikey-modal-backdrop, —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è .modal */
    .apikey-btn {
      width: 100%;
      min-width: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #181c22;
      color: #fff;
      border: 1.5px solid #23272f;
      border-radius: 18px;
      font-size: 1.13em;
      font-weight: 700;
      box-shadow: 0 4px 16px #0008, 0 0 0 2px #23272f inset;
      transition: box-shadow 0.2s, background 0.2s, color 0.2s;
      cursor: pointer;
      margin: 0;
      letter-spacing: 0.5px;
      padding: 0.8em 1.5em;
    }
    .apikey-btn:hover, .apikey-btn:focus {
      background: #23272f;
      color: #fff;
      box-shadow: 0 6px 24px #000b, 0 0 0 2.5px #23272f inset;
    }
    .apikey-float input {
      width: 100%;
      min-width: 0;
      max-width: 220px;
      padding: 0.7em 1em;
      border-radius: 10px;
      border: 1px solid #333a;
      background: #181c22;
      color: #fff;
      font-size: 1em;
      margin-bottom: 0.5em;
      overflow: hidden;
      text-overflow: ellipsis;
      box-sizing: border-box;
    }
    .apikey-float label {
      font-size: 0.98em;
      color: #fff;
      margin-bottom: 0.3em;
      display: block;
    }
    .user {
      margin: 0.5em 0 0.5em 1.2em;
      font-size: 1.05em;
      color: #fff;
      opacity: 0.85;
    }
    .chatbox {
      flex: 1 1 auto;
      width: 100vw;
      max-width: 100vw;
      overflow-y: auto;
      padding: 1.2em 0.8em 1.2em 0.8em;
      box-sizing: border-box;
      background: transparent;
      display: flex;
      flex-direction: column;
      gap: 0.7em;
      font-size: 1.04em;
      scroll-behavior: smooth;
      padding-bottom: 5em; /* —á—Ç–æ–±—ã input-row –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª */
    }
    .msg {
      max-width: 80vw;
      padding: 0.9em 2.2em;
      border-radius: 8px;
      margin-bottom: 0.2em;
      word-break: break-word;
      box-shadow: 0 2px 8px #0002;
      background: #22252a;
      color: #fff;
      align-self: flex-start;
      font-family: 'Geologica', sans-serif;
      font-optical-sizing: auto;
      font-variation-settings: "slnt" 0, "CRSV" 0, "SHRP" 0;
      font-weight: 100;
    }
    .msg.user {
      background: #23272f;
      color: #fff;
      align-self: flex-end;
      box-shadow: 0 2px 8px #1a6cff33;
      border-radius: 8px;
      padding-left: 2.2em;
      padding-right: 2.2em;
      font-family: 'Geologica', sans-serif;
      font-optical-sizing: auto;
      font-variation-settings: "slnt" 0, "CRSV" 0, "SHRP" 0;
      font-weight: 100;
    }
    .msg.assistant {
      background: #22252a;
      color: #fff;
      border-radius: 8px;
      padding-left: 2.2em;
      padding-right: 2.2em;
      font-family: 'Geologica', sans-serif;
      font-optical-sizing: auto;
      font-variation-settings: "slnt" 0, "CRSV" 0, "SHRP" 0;
      font-weight: 100;
    }
    .booking-card {
      background: #23272f;
      color: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 12px #0004;
      margin: 0.7em 0;
      padding: 1.2em 1em 1em 1em;
      position: relative;
      max-width: 98vw;
      font-size: 1.04em;
      transition: border 0.2s, box-shadow 0.2s;
      font-family: 'Geologica', sans-serif;
      font-optical-sizing: auto;
      font-variation-settings: "slnt" 0, "CRSV" 0, "SHRP" 0;
      font-weight: 100;
    }
    .booking-card.selected {
      border: 2px solid #444;
      box-shadow: 0 0 0 2px #222;
    }
    .booking-btn, .booking-btn.confirm-btn {
      background: #181a1f;
      color: #fff;
      border: 1.5px solid #23272f;
      border-radius: 50px;
      padding: 0.7em 2.2em;
      font-weight: 700;
      cursor: pointer;
      margin: 0.5em 0.2em 0 0;
      font-size: 1.13em;
      transition: box-shadow 0.2s, background 0.2s, border 0.2s;
      box-shadow: 0 4px 16px #0008, 0 0 0 2px #23272f inset;
      outline: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
      min-height: 44px;
      height: 44px;
      line-height: 1;
    }
    .booking-btn:hover, .booking-btn.confirm-btn:hover {
      background: #23272f;
      box-shadow: 0 6px 24px #000b, 0 0 0 2.5px #23272f inset;
      border: 1.5px solid #23272f;
      color: #fff;
    }
    .input-row {
      width: 100vw;
      max-width: 100vw;
      background: transparent;
      padding: 0 0 1.2em 0;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: flex-end;
    }
    .input-wrapper {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      align-items: flex-end;
    }
    .input-row input {
      display: none;
    }
    .input-row textarea {
      width: 100%;
      min-height: 120px;
      max-height: 160px;
      height: 140px;
      padding: 2.2em 4em 0.7em 2em;
      border-radius: 22px;
      border: 1.5px solid #333a;
      background: #24272d;
      color: #fff;
      font-size: 1.13em;
      outline: none;
      margin: 0;
      box-shadow: 0 2px 12px #0003;
      box-sizing: border-box;
      transition: border 0.2s;
      resize: none;
      vertical-align: top;
      text-align: left;
      margin-right: 0.7em;
    }
    .input-row textarea:focus {
      border: 1.5px solid #7ecfff;
    }
    .input-row button {
      position: absolute;
      right: 1.1em;
      bottom: 1.1em;
      background: #181a1f;
      color: #fff;
      border: 1.5px solid #23272f;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.25em;
      font-weight: 700;
      cursor: pointer;
      transition: box-shadow 0.2s, background 0.2s, border 0.2s;
      box-shadow: 0 4px 16px #0008, 0 0 0 2px #23272f inset;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      margin: 0;
      outline: none;
    }
    .input-row button:hover, .input-row button:focus {
      background: #23272f;
      box-shadow: 0 6px 24px #000b, 0 0 0 2.5px #23272f inset;
      border: 1.5px solid #23272f;
      color: #fff;
    }
    .input-row button svg {
      width: 1.3em;
      height: 1.3em;
      fill: #fff;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0; top: 0; width: 100vw;
      min-height: 100dvh;
      background: rgba(24,28,34,0.85);
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .modal.active {
      display: flex;
      animation: fadeIn 0.2s;
    }
    .modal-content {
      background: #23272f;
      border-radius: 18px;
      padding: 2.5em 2em 2em 2em;
      min-width: 220px;
      max-width: 340px;
      width: 100%;
      margin: 0 auto;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
      color: #fff;
      border: 1.5px solid #23272f;
      box-shadow: 0 8px 32px #000b, 0 0 0 2px #23272f inset;
      animation: fadeIn 0.25s;
      max-height: 90dvh;
      overflow-y: auto;
    }
    .modal-content .modal-icon {
      font-size: 2.5em;
      margin-bottom: 0.3em;
      filter: drop-shadow(0 2px 8px #0008);
      user-select: none;
    }
    .modal-content h3 {
      font-size: 1.35em;
      font-weight: 700;
      margin: 0 0 1.2em 0;
      letter-spacing: 0.5px;
      text-align: center;
      color: #fff;
    }
    .modal-content input[type="text"],
    .modal-content input[type="password"] {
      width: 100%;
      padding: 0.95em 1.2em 0.95em 2.5em; /* —á—É—Ç—å –º–µ–Ω—å—à–µ padding-top/bottom */
      border-radius: 12px;
      border: 1.5px solid #333a;
      background: #181c22;
      color: #fff;
      font-size: 0.95em;
      margin-bottom: 0.7em;
      box-shadow: 0 2px 8px #0002;
      box-sizing: border-box;
      outline: none;
      transition: border 0.2s;
      position: relative;
      line-height: 1.2;
      font-family: 'Martian Mono', monospace !important;
      font-optical-sizing: auto;
      font-variation-settings: "wdth" 100;
    }
    .modal-content input[type="text"]:focus,
    .modal-content input[type="password"]:focus {
      border: 1.5px solid #7ecfff;
    }
    .modal-content .input-icon {
      position: absolute;
      left: 1.1em;
      top: 50%;
      transform: translateY(-52%); /* –±—ã–ª–æ -50%, —á—É—Ç—å –Ω–∏–∂–µ */
      font-size: 1.3em; /* —É–≤–µ–ª–∏—á–µ–Ω–æ */
      color: #fff;
      pointer-events: none;
      vertical-align: middle;
      line-height: 1;
    }
    .modal-content .modal-input-wrap {
      position: relative;
      width: 100%;
      margin-bottom: 0.7em;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content input[type="text"]:focus {
      border: 1.5px solid #7ecfff;
    }
    .modal-content .modal-input-wrap {
      position: relative;
      width: 100%;
      margin-bottom: 0.7em;
    }
    #pay-btn {
      margin-top: 0.7em;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #181a1f;
      color: #fff;
      border: 1.5px solid #23272f;
      border-radius: 50px;
      font-size: 1.13em;
      font-weight: 700;
      padding: 0.9em 0;
      box-shadow: 0 4px 16px #0008, 0 0 0 2px #23272f inset;
      transition: box-shadow 0.2s, background 0.2s, border 0.2s;
      cursor: pointer;
    }
    #pay-btn:hover, #pay-btn:focus {
      background: #23272f;
      box-shadow: 0 6px 24px #000b, 0 0 0 2.5px #23272f inset;
      border: 1.5px solid #23272f;
      color: #fff;
    }
    #pay-btn svg {
      width: 1.3em;
      height: 1.3em;
      fill: #fff;
      margin-right: 0.6em;
      vertical-align: middle;
    }
    .modal-close {
      position: absolute;
      top: 1em; right: 1em;
      font-size: 1.5em;
      color: #7ecfff;
      cursor: pointer;
      z-index: 10;
    }
    .modal-backdrop {
      display: none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(24,28,34,0.95);
      z-index: 1000;
    }
    .modal-backdrop.active {
      display: block;
      animation: fadeIn 0.2s;
    }
    @media (max-width: 600px) {
      .chatbox, .msg, .booking-card {
        font-size: 0.98em;
        padding-left: 0.5em;
        padding-right: 0.5em;
        box-sizing: border-box;
      }
      .input-row {
        padding-left: 0.5em;
        padding-right: 0.5em;
        box-sizing: border-box;
      }
      .apikey-float {
        right: 8px;
        min-width: 0;
        width: 95vw;
        max-width: 220px;
        box-sizing: border-box;
      }
      .modal-content {
        min-width: 90vw;
        max-width: 95vw;
        width: 90vw;
        padding: 1.2em 0.5em 1em 0.5em;
        box-sizing: border-box;
      }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: none; }
    }
    .booking-btn svg, .booking-btn.confirm-btn svg, #pay-btn svg {
      width: 1.2em;
      height: 1.2em;
      fill: #fff;
      margin-right: 0.5em;
      vertical-align: middle;
    }
    @media (max-width: 900px) {
      .apikey-float-inner {
        flex-direction: column;
        align-items: stretch;
        min-width: 0;
        max-width: 99vw;
        width: 99vw;
        padding: 1.2em 0.7em 1.2em 0.7em;
        gap: 1.1em;
      }
      .apikey-float .apikey-icon {
        margin: 0 0 0.7em 0;
        justify-content: center;
      }
      .apikey-float input {
        margin-bottom: 1.1em;
        min-width: 0;
        max-width: 100%;
      }
      .apikey-float .apikey-btn {
        width: 100%;
        min-width: 0;
        border-radius: 50px;
        margin-top: 0.7em;
        height: 48px;
      }
    }
    .modal, .modal-content {
      -webkit-overflow-scrolling: touch;
    }
    @media (max-width: 600px) {
      .modal {
        position: absolute;
        align-items: flex-start;
        justify-content: flex-start;
      }
      .modal-content {
        margin-top: 15vh;
      }
    }
    .modal-content.apikey-modal-content {
      min-height: 320px;
    }
    @media (max-width: 600px) {
      .modal-content.apikey-modal-content {
        min-height: 220px;
      }
    }
    .material-symbols-outlined.header-icon {
      color: #fff;
      font-size: 18px;
      font-variation-settings:
        'FILL' 0,
        'wght' 200,
        'GRAD' 0,
        'opsz' 24;
    }
    .material-symbols-outlined.send-icon {
      font-size: 36px;
      transform: rotate(-45deg) scale(0.67);
      display: inline-block;
      vertical-align: middle;
      transition: color 0.2s;
      font-variation-settings:
        'FILL' 0,
        'wght' 200,
        'GRAD' 0,
        'opsz' 24;
      background: linear-gradient(115deg, rgba(255,255,255,0.75) 60%, rgba(255,255,255,0) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
    }
  </style>
</head>
<body>
  <div class="modal" id="apikey-modal">
    <div class="modal-content apikey-modal-content">
      <span class="modal-close" onclick="closeApikeyModal()">&times;</span>
      <span class="modal-icon">üîë</span>
      <h3>–í–≤–µ–¥–∏—Ç–µ Gemini API Key</h3>
      <div class="modal-input-wrap">
        <span class="input-icon">üîë</span>
        <input type="text" id="api-key" placeholder="Gemini API Key" autocomplete="off" inputmode="text" spellcheck="false" style="padding-left:2.5em;width:100%;max-width:340px;border:2px solid #7ecfff;background:#232b36;color:#fff;font-size:1.15em;box-shadow:0 2px 12px #0003;border-radius:14px;" />
      </div>
      <button class="apikey-btn" id="apikey-save-btn" type="button" style="margin-top:0.7em;width:100%;display:flex;align-items:center;justify-content:center;background:#181a1f;color:#fff;border:1.5px solid #23272f;border-radius:50px;font-size:1.13em;font-weight:700;padding:0.9em 0;box-shadow:0 4px 16px #0008,0 0 0 2px #23272f inset;transition:box-shadow 0.2s,background 0.2s,border 0.2s;cursor:pointer;">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>
  <div class="container">
    <div class="header">
      <span class="app-title">NOW</span>
      <div style="display: flex; gap: 0.7em; align-items: center;">
        <button class="key-btn" id="booking-btn" title="–û—Ñ–æ—Ä–º–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ">
          <span class="material-symbols-outlined header-icon">add_card</span>
        </button>
      <button class="key-btn" id="show-key-btn" title="API Key">
          <span class="material-symbols-outlined header-icon">key_vertical</span>
      </button>
      </div>
    </div>
    <div class="user" id="user-info">Loading user info...</div>
    <div class="chatbox" id="chatbox"></div>
    <form id="chat-form" class="input-row" autocomplete="off">
      <div class="input-wrapper">
        <textarea id="user-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–±—Ä–æ–Ω–∏—Ä—É–π —Å—Ç–æ–ª–∏–∫ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ –Ω–∞ –≤–µ—á–µ—Ä" required rows="2"></textarea>
        <button type="submit" id="send-btn" title="Send">
          <span class="material-symbols-outlined send-icon">send</span>
        </button>
      </div>
    </form>
    <!-- Payment Modal -->
    <div class="modal" id="payment-modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closePaymentModal()">&times;</span>
        <span class="modal-icon">üí≥</span>
        <h3>–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É</h3>
        <div id="modal-booking-details"></div>
        <div style="margin: 1em 0; width: 100%;">
          <div class="modal-input-wrap">
            <span class="input-icon">üí≥</span>
          <input type="text" id="card-number" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: 1234 5678 9012 3456" maxlength="19" />
          </div>
          <div class="modal-input-wrap">
            <span class="input-icon">üìÖ</span>
          <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5" />
          </div>
          <div class="modal-input-wrap">
            <span class="input-icon">üîí</span>
          <input type="text" id="card-cvv" placeholder="CVV" maxlength="3" />
          </div>
          <div class="modal-input-wrap">
            <span class="input-icon">üë§</span>
          <input type="text" id="card-name" placeholder="–ò–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–∞—Ä—Ç—ã" />
          </div>
        </div>
        <button type="button" id="pay-btn"><svg viewBox="0 0 24 24"><path d="M21 7v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2zm-2 0H5v2h14V7zm0 4H5v6h14v-6z"/></svg>–ü—Ä–∏–≤—è–∑–∞—Ç—å</button>
      </div>
    </div>
  </div>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // --- –ù–æ–≤—ã–π –º–æ–¥–∞–ª –¥–ª—è API Key ---
    const showKeyBtn = document.getElementById('show-key-btn');
    const apikeyModal = document.getElementById('apikey-modal');
    const apikeySaveBtn = document.getElementById('apikey-save-btn');
    function openApikeyModal() {
      apikeyModal.classList.add('active');
      const apiKeyInput = document.getElementById('api-key');
      // –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫–ª—é—á, –µ—Å–ª–∏ –µ—Å—Ç—å
      const savedKey = localStorage.getItem('gemini_api_key') || '';
      apiKeyInput.value = savedKey;
      setTimeout(() => { apiKeyInput.focus(); }, 150);
      apiKeyInput.type = 'text';
    }
    function closeApikeyModal() {
      apikeyModal.classList.remove('active');
    }
    showKeyBtn.onclick = openApikeyModal;
    apikeySaveBtn.onclick = () => {
      const apiKeyInput = document.getElementById('api-key');
      const realValue = apiKeyInput.getAttribute('data-real') || '';
      localStorage.setItem('gemini_api_key', realValue.trim());
      closeApikeyModal();
    };
    // –ö–ª–∏–∫ –ø–æ —Ç—ë–º–Ω–æ–π –ø–æ–¥–ª–æ–∂–∫–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É
    apikeyModal.addEventListener('mousedown', function(e) {
      if (e.target === apikeyModal) {
        closeApikeyModal();
      }
    });
    // Enter –Ω–∞ input —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç
    document.getElementById('api-key').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const realValue = this.getAttribute('data-real') || '';
        localStorage.setItem('gemini_api_key', realValue.trim());
        closeApikeyModal();
        e.preventDefault();
      }
    });

    // –ö–Ω–æ–ø–∫–∞ "–û—Ñ–æ—Ä–º–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ" (–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É)
    const bookingBtn = document.getElementById('booking-btn');
    const paymentModal = document.getElementById('payment-modal');
    bookingBtn.onclick = () => {
      paymentModal.classList.add('active');
    };
    function closePaymentModal() {
      paymentModal.classList.remove('active');
    }
    // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ)
    window.addEventListener('DOMContentLoaded', () => {
      paymentModal.classList.remove('active');
    });
    // –ö–ª–∏–∫ –ø–æ —Ç—ë–º–Ω–æ–π –ø–æ–¥–ª–æ–∂–∫–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É
    paymentModal.addEventListener('mousedown', function(e) {
      if (e.target === paymentModal) {
        closePaymentModal();
      }
    });

    // –ö–Ω–æ–ø–∫–∞ OK –≤ apikey-float –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –±–ª–æ–∫
    // –£–¥–∞–ª—è—é —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É apikey-float –∏ apikey-modal-backdrop

    // Telegram user info
    const tg = window.Telegram.WebApp;
    tg.ready();
    const chatbox = document.getElementById('chatbox');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');

    function appendAssistantGreeting() {
      let greeting = '';
      if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        const user = tg.initDataUnsafe.user;
        const name = user.first_name || user.last_name || user.username || '–ì–æ—Å—Ç—å';
        greeting = `–ü—Ä–∏–≤–µ—Ç, ${name}`;
      } else {
        greeting = '–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω.';
      }
      const div = document.createElement('div');
      div.className = 'msg assistant';
      div.textContent = greeting;
      if (chatbox.firstChild) {
        chatbox.insertBefore(div, chatbox.firstChild);
      } else {
        chatbox.appendChild(div);
      }
    }
    appendAssistantGreeting();
    document.getElementById('user-info').style.display = 'none';

    userInput.addEventListener('keydown', function(e) {
      if (window.innerWidth > 600) {
        if (e.key === 'Enter' && !e.ctrlKey) {
          e.preventDefault();
          chatForm.requestSubmit();
        }
        // Ctrl+Enter ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
      }
    });
    // apiKeyInput —Ç–µ–ø–µ—Ä—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π, —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –±—Ä–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π value

    // Available data files mapping
    const dataFiles = {
      'events-moscow': '/NOW/miniapp/events-moscow.json',
      'events-spb': '/NOW/miniapp/events-spb.json',
      'people-moscow': '/NOW/miniapp/people-moscow.json',
      'contractors-moscow': '/NOW/miniapp/contractors-moscow.json',
      'services-moscow': '/NOW/miniapp/services-moscow.json'
    };

    let currentData = {};
    let dataLoaded = false;
    let messages = [];
    let selectedItem = null; // Store selected booking item

    function appendMessage(role, content, bookingData = null) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      const textDiv = document.createElement('div');
      textDiv.textContent = (role === 'user' ? 'You: ' : 'Assistant: ') + content;
      div.appendChild(textDiv);
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Gemini API endpoint
    const GEMINI_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è GPT (–æ–±—ä—è—Å–Ω–µ–Ω–∏—è), –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    function extractGptComment(reply, items) {
      if (!reply) return '';
      let text = reply;
      // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç hash: <hash>
      const lines = text.split('\n');
      const hashPattern = /hash:\s*[a-fA-F0-9]{8,}/;
      const ignorePatterns = [
        /^\s*[-*‚Ä¢\d\.]+/, // markdown-—Å–ø–∏—Å–∫–∏, —ç–º–æ–¥–∑–∏, —Ü–∏—Ñ—Ä—ã
        /^\s*\*\*/, // –∂–∏—Ä–Ω—ã–µ markdown
        /^\s*–û–ø–∏—Å–∞–Ω–∏–µ:/i,
        /^\s*–ú–µ—Å—Ç–æ:/i,
        /^\s*–î–∞—Ç–∞:/i,
        /^\s*–í—Ä–µ–º—è:/i,
        /^\s*–¶–µ–Ω–∞:/i,
        /^\s*–ö–æ–Ω—Ç–∞–∫—Ç:/i,
        /^\s*–†–µ–π—Ç–∏–Ω–≥:/i,
        /^\s*–£—Å–ª—É–≥–∞:/i,
        /^\s*–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:/i,
        /^\s*–û–ø—ã—Ç:/i
      ];
      let filtered = lines.filter(line => {
        if (!line.trim()) return false;
        if (hashPattern.test(line)) return false;
        if (ignorePatterns.some(re => re.test(line))) return false;
        if (Array.isArray(items)) {
          for (const item of items) {
            if (item.name && line.includes(item.name)) return false;
            if (item.description && line.includes(item.description)) return false;
            if (item.venue && line.includes(item.venue)) return false;
            if (item.price_range && line.includes(item.price_range)) return false;
            if (item.currency && line.includes(item.currency)) return false;
          }
        }
        return true;
      });
      const comment = filtered.join(' ').replace(/\s+/g, ' ').trim();
      if (comment.length > 10) return comment;
      return '';
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ hash –∏–∑ –æ—Ç–≤–µ—Ç–∞ GPT
    function filterMentionedItemsByHash(items, replyText) {
      // –ù–∞–π—Ç–∏ –≤—Å–µ hash: <hash> –≤ –æ—Ç–≤–µ—Ç–µ
      const hashes = Array.from(replyText.matchAll(/hash:\s*([a-fA-F0-9]{8,})/g)).map(m => m[1]);
      return items.filter(item => hashes.includes(item.hash));
    }

    // –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    function renderBookingCards(items) {
      // Remove previous cards
      const oldCards = document.querySelectorAll('.booking-card');
      oldCards.forEach(card => card.remove());
      // State: only one selected at a time
      let selectedCard = null;
      let selectedBookingItem = null;
      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'booking-card';
        card.style = 'background:#23272f;margin:1em 0;padding:1em;border-radius:18px;box-shadow:0 2px 8px #0004;position:relative;';
        let html = `<strong style="color:#7ecfff;">${item.name}</strong><br>`;
        if (item.venue) html += `–ú–µ—Å—Ç–æ: ${item.venue}<br>`;
        if (item.date) html += `–î–∞—Ç–∞: ${item.date}<br>`;
        if (item.time) html += `–í—Ä–µ–º—è: ${item.time}<br>`;
        if (item.price_range) html += `–¶–µ–Ω–∞: ${item.price_range} ${item.currency || 'RUB'}<br>`;
        if (item.specialization) html += `–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: ${item.specialization}<br>`;
        if (item.experience) html += `–û–ø—ã—Ç: ${item.experience}<br>`;
        if (item.rating) html += `–†–µ–π—Ç–∏–Ω–≥: ${item.rating}<br>`;
        if (item.contact) html += `–ö–æ–Ω—Ç–∞–∫—Ç: ${item.contact}<br>`;
        if (item.description) html += `–û–ø–∏—Å–∞–Ω–∏–µ: ${item.description}<br>`;
        card.innerHTML = html;
        // –í—ã–±—Ä–∞—Ç—å
        const selectBtn = document.createElement('button');
        selectBtn.className = 'booking-btn';
        selectBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z"/></svg>–í—ã–±—Ä–∞—Ç—å';
        selectBtn.onclick = () => {
          document.querySelectorAll('.booking-card.selected').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedBookingItem = item;
          document.querySelectorAll('.booking-card .confirm-btn').forEach(b => b.style.display = 'none');
          confirmBtn.style.display = 'inline-block';
        };
        card.appendChild(selectBtn);
        // –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞)
        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'booking-btn confirm-btn';
        confirmBtn.style.background = '#28a745';
        confirmBtn.style.display = 'none';
        confirmBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zm0-13H5V6h14v1z"/></svg>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å${item.price_range ? ' –∑–∞ ' + item.price_range + ' ' + (item.currency || 'RUB') : ''}`;
        confirmBtn.onclick = () => showPaymentForm(item);
        card.appendChild(confirmBtn);
        document.getElementById('chatbox').appendChild(card);
      });
    }

    // Handle form submission
    chatForm.onsubmit = async (e) => {
      e.preventDefault();
      e.stopPropagation();

      const apiKey = document.getElementById('api-key').value || '';
      const apiKeyFinal = apiKey || localStorage.getItem('gemini_api_key') || '';
      if (!apiKeyFinal) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à Gemini API Key!');
        return;
      }

      const content = userInput.value.trim();
      if (!content) return;

      appendMessage('user', content);
      userInput.value = '';
      appendMessage('assistant', '–û–ø—Ä–µ–¥–µ–ª—è—é –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...');

      try {
        // First, ask Gemini to determine which data file is needed
        const fileSelectionPrompt = `You are a data file selector. Based on the user's request, determine which JSON file should be loaded.\n\nAvailable files:\n- events-moscow.json (events in Moscow)\n- events-spb.json (events in Saint Petersburg) \n- people-moscow.json (professionals in Moscow)\n- contractors-moscow.json (construction/repair services in Moscow)\n- services-moscow.json (various services in Moscow)\n\nRespond ONLY with the filename (e.g., "events-moscow") without .json extension.`;

        // Gemini file selection request
        const fileRes = await fetch(GEMINI_ENDPOINT + '?key=' + apiKeyFinal, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json; charset=utf-8'
          },
          body: JSON.stringify({
            contents: [
              { parts: [ { text: fileSelectionPrompt + "\n\n" + content } ] }
            ]
          })
        });
        const fileData = await fileRes.json();
        let selectedFile = '';
        if (fileData.candidates && fileData.candidates[0] && fileData.candidates[0].content && fileData.candidates[0].content.parts && fileData.candidates[0].content.parts[0]) {
          selectedFile = fileData.candidates[0].content.parts[0].text.trim().toLowerCase();
        }
        // Load the selected data file
        if (dataFiles[selectedFile]) {
          try {
            const dataRes = await fetch(dataFiles[selectedFile]);
            if (!dataRes.ok) {
              throw new Error(`HTTP ${dataRes.status}: ${dataRes.statusText}`);
            }
            const loadedData = await dataRes.json();
            currentData = loadedData;
            dataLoaded = true;
          } catch (dataError) {
            chatbox.removeChild(chatbox.lastChild);
            appendMessage('assistant', '–û—à–∏–±–∫–∞: ' + dataError.message);
            return;
          }
          chatbox.removeChild(chatbox.lastChild);
          // Now create the main response with loaded data
          const systemPrompt = `You are an AI assistant for a comprehensive booking and service platform. You have access to the following data:\n\n${JSON.stringify(currentData, null, 2)}\n\nYour task is to help users with:\n- Booking events and venues\n- Finding professionals and experts\n- Hiring contractors for services\n- Accessing various local services\n\nIMPORTANT: For each suggested option, you MUST include its hash from the data (e.g., hash: abc123). For every option, write a line like: hash: <hash>.\n\nWhen the user confirms booking, respond as before.`;
          // Gemini main response request
          const mainRes = await fetch(GEMINI_ENDPOINT + '?key=' + apiKeyFinal, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json; charset=utf-8'
            },
            body: JSON.stringify({
              contents: [
                { parts: [ { text: systemPrompt + "\n\n" + content } ] }
              ]
            })
          });
          const mainData = await mainRes.json();
          if (mainData.candidates && mainData.candidates[0] && mainData.candidates[0].content && mainData.candidates[0].content.parts && mainData.candidates[0].content.parts[0]) {
            const reply = mainData.candidates[0].content.parts[0].text.trim();
            let mentionedItems = [];
            if (currentData.data && Array.isArray(currentData.data) && currentData.data.length > 0) {
              mentionedItems = filterMentionedItemsByHash(currentData.data, reply);
              let comment = extractGptComment(reply, mentionedItems);
              if (comment) {
                appendMessage('assistant', comment, null);
              }
              if (mentionedItems.length > 0) {
                renderBookingCards(mentionedItems);
              }
            }
          } else {
            appendMessage('assistant', '–û—à–∏–±–∫–∞: ' + (mainData.error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        } else {
          chatbox.removeChild(chatbox.lastChild);
          appendMessage('assistant', `–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (${selectedFile}). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å.`);
        }
      } catch (err) {
        chatbox.removeChild(chatbox.lastChild);
        appendMessage('assistant', '–û—à–∏–±–∫–∞: ' + err.message);
      }
    };

    // (–£–¥–∞–ª—ë–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ send-btn, —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ submit —Ñ–æ—Ä–º—ã)

    // Payment logic (–æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –±—ã–ª–æ)
    // ... –≤–∞—à –∫–æ–¥ –æ–ø–ª–∞—Ç—ã –∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ...
  </script>
</body>
</html>
